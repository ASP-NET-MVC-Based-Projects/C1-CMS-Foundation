if(typeof bespin==="undefined")bespin={};if(typeof document!=="undefined"){var link=document.getElementById("bespin_base");if(link){var href=link.href;bespin.base=href.substring(href.length-1)!=="/"?href+"/":href}else bespin.base=""}
(function(){if("undefined"===typeof u)var u=function(){function j(s,l){w.push({m:s,a:l})}var w=[],A={isBootstrap:true,queue:w,register:function(s,l){if(s.match(/^tiki/)&&this.ENV)if(this.ENV.app==="tiki"&&this.ENV.mode==="test"){if(!l.dependencies)l.dependencies={};l.dependencies.core_test="~"}j("register",arguments);return this},module:function(s,l){if(s.match(/\:tiki$/))this.tikiFactory=l;j("module",arguments);return this},start:function(){var s={};this.tikiFactory(null,s,null);s=s.Browser.start(this.ENV,
this.ARGS,w);w=null;return s}};if("undefined"!==typeof ENV)A.ENV=ENV;if("undefined"!==typeof ARGV)A.ARGS=ARGV;if("undefined"!==typeof ARGS)A.ARGS=ARGS;return A}();u.register("::tiki/1.0.0",{name:"tiki",version:"1.0.0"});u.module("::tiki/1.0.0:tiki",function(j,w){var A=/^::/,s=function(a){return!!A.exec(a)},l=function(){w.debug.apply(this,arguments)};w.debug=function(){var a=Array.prototype.join.call(arguments,"");j("sys").debug(a)};var d;d=Array.isArray?Array.isArray:function(a){if("object"!==typeof a)return false;
if(a instanceof Array)return true;return a.constructor&&a.constructor.name==="Array"};w.isArray=d;var g;if(Object.create)g=Object.create;else{var k=function(){},z=k.prototype;g=function(a){if(!a)a=Object.prototype;k.prototype=a;var b=new k;b.prototype=a;k.prototype=z;return b}}w.createObject=g;var p,n,C;p=function(){return function(){return this.init?this.init.apply(this,arguments):this}};n=function(){return C(this)};C=function(a){var b=p();b.prototype=g(a.prototype);b.prototype.constructor=b;b.super_=
a;b.extend=n;return b};w.extend=C;var e=function(a,b){if(b&&!b.displayName)b.displayName="parallel#fn";return function(c){if(a.length===0)return c(null,[]);var h=a.length,q=h,t=false,F,H=function(M){if(!t){if(M){t=true;return c(M)}--q<=0&&c()}};H.displayName="parallel#tail";for(F=0;F<h;F++)b(a[F],H)}};e.displayName="parallel";var i;i=Array.prototype.map?function(a,b){return a.map(b)}:function(a,b){var c,h=a.length,q=[];for(c=0;c<h;c++)q[c]=b(a[c],c);return q};i.displayName="map";var r=function(a,
b){var c="pending",h=[],q=false,t=null,F=function(H){b||(b=this);switch(c){case "ready":H.apply(null,t);break;case "running":h.push(H);break;case "pending":h.push(H);c="running";a.call(b,function(){t=Array.prototype.slice.call(arguments);var M=h,Q=t;if(q){c="pending";h=[];t=null;q=false}else{c="ready";h=null}M&&M.forEach(function(S){S.apply(null,Q)})});break}return this};F.displayName="once#handler";F.reset=function(){switch(c){case "ready":c="pending";h=[];t=null;break;case "running":q=true;break}};
F.reset.displayName="once#handler.reset";return F};w.once=r;var v=function(a,b){var c,h;for(c in a)if(a.hasOwnProperty(c)){h=a[c];if("function"===typeof h)if(!h.displayName){h.displayName=b?b+"."+c:c;v(h.prototype,h.displayName)}}return a},D=C(Error);D.prototype.init=function(a,b){a=a+" not found";if(b)a="string"===typeof b?a+" "+b:a+" in package "+(b.id||"(unknown)");this.message=a;return this};w.NotFound=D;var G=C(Error);G.prototype.init=function(a,b){if("undefined"!==typeof JSON)a=JSON.stringify(a);
this.message="Invalid package definition. "+b+" "+a};w.InvalidPackageDef=G;var P=function(){var a=function(h){return h.charCodeAt(0)<=32},b=function(h){h=h.charCodeAt(0);return h>=48&&h<=57},c=function(h,q){for(var t=0,F=0,H=0,M,Q;;F++,H++){M=h.charAt(F);Q=q.charAt(H);if(!b(M)&&!b(Q))return t;else if(b(M))if(b(Q)){if(M<Q)if(t===0)t=-1;else if(M>Q)if(t===0)t=+1;else if(M===0&&Q===0)return t}else return+1;else return-1}};return function(h,q){for(var t=0,F=0,H=0,M=0,Q,S,Y;;){H=M=0;Q=h.charAt(t);for(S=
q.charAt(F);a(Q)||Q=="0";){if(Q=="0")H++;else H=0;Q=h.charAt(++t)}for(;a(S)||S=="0";){if(S=="0")M++;else M=0;S=q.charAt(++F)}if(b(Q)&&b(S))if((Y=c(h.substring(t),q.substring(F)))!==0)return Y;if(Q===0&&S===0)return H-M;if(Q<S)return-1;else if(Q>S)return+1;++t;++F}}}();w.natcompare=P;var K=function(a){return new Error(""+a+" is an invalid version string")};K.displayName="invalidVers";var R=function(a,b,c,h){c=Number(c);h=Number(h);if(isNaN(c))throw K(a);if(isNaN(h))throw K(b);return c-h};R.displayName=
"compareNum";var m,N={parse:function(a){a=a.match(/^(=|~)?([\d]+?)(\.([\d]+?)(\.(.+))?)?$/);if(!a)return null;return[a,a[2],a[4]||"0",a[6]||"0",a[1]]},major:function(a){return Number(m(a)[1])},minor:function(a){return Number(m(a)[2])},patch:function(a){a=m(a)[3];return isNaN(Number(a))?a:Number(a)},STRICT:"strict",NORMAL:"normal",mode:function(a){return m(a)[4]==="="?N.STRICT:N.NORMAL},comparePatch:function(a,b){var c,h;if(a===b)return 0;c=Number(a);h=Number(b);return isNaN(c)?isNaN(h)?P(a,b):-1:
isNaN(h)?1:c<h?-1:c>h?1:0},compare:function(a,b){var c;if(a===b)return 0;if(a)a=m(a);if(b)b=m(b);if(!a&&!b)return 0;if(!a)return-1;if(!b)return 1;c=R(a[0],b[0],a[1],b[1]);if(c===0){c=R(a[0],b[0],a[2],b[2]);if(c===0)c=N.comparePatch(a[3],b[3])}return c<0?-1:c>0?1:0},compatible:function(a,b){if(!a)return true;if(a===b)return true;if(a&&!m(a))a=null;if(b&&!m(b))b=null;if(!a)return true;if(a===b)return true;if(N.mode(a)===N.STRICT)return b&&N.compare(a,b)===0;else{if(!b)return true;if(N.major(a)!==N.major(b))return false;
return N.compare(a,b)<=0}},normalize:function(a){var b;if(!a||a.length===0)return null;a=N.parse(a);if(!a)return null;b=Number(a[3]);if(isNaN(b))b=a[3];return[Number(a[1]),Number(a[2]),b].join(".")}};w.semver=N;m=N.parse;var U=w.extend(Object);w.Factory=U;U.prototype.init=function(a,b,c){this.id=a;this.pkg=b;this.factory=c};U.prototype.call=function(a,b){var c=this.factory,h=this.__filename,q=this.__dirname;if("string"===typeof c)c=this.factory=U.compile(c,this.pkg.id+":"+this.id);a=a.createRequire(b);
var t=b.exports;c.call(t,a,t,b,h,q);return b.exports};var V=["(function(require, exports, module) {",null,"\n});\n//@ sourceURL=",null,"\n"];U.compile=function(a,b){V[1]=a;V[3]=b||"(unknown module)";a=V.join("");a=eval(a);V[1]=V[3]=null;return a};w.Factory=U;var T=w.extend(Object);w.Module=T;T.prototype.init=function(a,b,c){this.id=a;this.ownerPackage=b;this.exports={};var h=this;this.resource=function(q){return c.resource(q,h.id,b)}};var L=w.extend(Object);w.Package=L;L.prototype.init=function(a,
b){s(a)||(a="::"+a);this.id=a;this.config=b;this.isReady=true};L.prototype.get=function(a){return this.config?this.config[a]:undefined};L.prototype.set=function(a,b){if(!this.config)this.config={};this.config[a]=b;return this};L.prototype.requiredVersion=function(a){var b=this.get("dependencies");return b?b[a]:null};L.prototype.canonicalPackageId=function(a,b){if(a===this.get("name")&&N.compatible(b,this.get("version")))return this.id;return null};L.prototype.packageFor=function(a){if(a===this.id)return this;
return null};L.prototype.ensurePackage=function(a,b){return a===this.id?b():b(new D(a,this))};L.prototype.catalogPackages=function(){return[this]};L.prototype.exists=function(a){return!!(this.factories&&this.factories[a])};L.prototype.load=function(a){return this.factories?this.factories[a]:null};var f=function(a,b){return a+":"+b},o=w.extend(Object);w.Loader=o;o.prototype.init=function(a){this.sources=a||[];this.clear()};o.prototype.clear=function(){this.factories={};this.canonicalIds={};this.packages=
{};this.packageSources={};this.canonicalPackageIds={}};o.prototype.defaultPackage=new L("default",{name:"default"});o.prototype.anonymousPackage=new L("(anonymous)",{name:"(anonymous)"});o.prototype.canonical=function(a,b,c){var h,q,t,F;if(b&&"string"!==typeof b){c=b;b=null}if(s(a))return a;if(!c)c=this.anonymousPackage;a=this._resolve(a,b,c);if(s(a))return a;h=c?c.id:"(null)";b=this.canonicalIds;if(!b)b=this.canonicalIds={};b[h]||(b[h]={});b=b[h];if(b[a])return b[a];h=a;q=a.indexOf(":");if(q>=0){t=
a.slice(0,q);a=a.slice(q+1);if(a[0]==="/")throw new Error("Absolute path not allowed with packageId");}q=null;if(t&&t.length>0){if(t=this._canonicalPackageId(t,null,c))q=f(t,a)}else{if(c&&c.exists(a))q=f(c.id,a);else{if(t=this._canonicalPackageId(a,null,c))F=this._packageFor(t,c);if(F)if(F.exists("index"))q=f(F.id,"index");else if(F.exists(a))q=f(F.id,a)}if(!q){if(this.defaultPackage)t=this.defaultPackage.id;else if(this.workingPackage)t=this.workingPackage.id;else if(this.anonymousPackage)t=this.anonymousPackage.id;
else return null;if(t)q=f(t,a)}}return b[h]=q};o.prototype.load=function(a,b,c){var h,q,t;if(!b)b=this.anonymousPackage;h=this.factories;if(!h)h=this.factories={};if(h[a])return h[a];q=a.indexOf(":",2);t=a.slice(0,q);q=a.slice(q+1);(b=this._packageFor(t,b))||l("Loader#load - "+t+" not found for "+q);if(!b)return null;c=b.load(q,c);return h[a]=c};o.prototype.catalogPackages=function(a){if(!a)a=this.anonymousPackage;var b=[],c,h,q={};this.defaultPackage&&b.push(this.defaultPackage);var t=function(F){var H,
M,Q,S;if(F){M=F.length;for(H=0;H<M;H++){S=F[H];(Q=q[S.get("name")])||(Q=q[S.get("name")]={});if(!Q[S.get("version")]){b.push(S);Q[S.get("version")]=S}}}};a&&t(a.catalogPackages());a=this.sources;h=a.length;for(c=0;c<h;c++)t(a[c].catalogPackages());q=null;return b};o.prototype.canonicalPackageId=function(a,b,c){var h;if(a instanceof L)return a.id;if(s(a)){h=a.indexOf(":",2);if(h>=0)a=a.slice(0,h);return a}if(b&&"string"!==typeof b){c=b;b=null}if(!c)c=this.anonymousPackage;h=a.indexOf(":");if(h>=0)a=
a.slice(0,h);return this._canonicalPackageId(a,b,c)};o.prototype.packageFor=function(a,b){if(!b)b=this.anonymousPackage;var c=a.indexOf(":",2);if(c>=0)a=a.slice(0,c);return this._packageFor(a,b)};o.prototype.ready=function(a,b){if(!b)b=this.anonymousPackage;var c=a.indexOf(":",2),h;if(c>=0){h=a.slice(c+1);a=a.slice(0,c)}if(this._packageReady(a,b,{})){a=this._packageFor(a,b);if(!a)return false;return!!a.exists(h)}else return false};o.prototype.ensurePackage=function(a,b,c,h){if(b&&"string"!==typeof b){h=
c;c=b;b=null}if(c&&"function"===typeof c){h=c;c=null}if(!c)c=this.anonymousPackage;this._ensurePackage(a,b,c,{},h)};o.prototype._ensurePackage=function(a,b,c,h,q){var t=this,F;F=this._canonicalPackageId(a,b,c);if(!F)return q(new D(a,c));if(h[F])return q();h[F]=true;a=this._sourceForCanonicalPackageId(F,c);if(!a)return q(new D(F,c));a.ensurePackage(F,function(H){var M,Q,S;if(H)return q(H);M=t.packageFor(F,c);if(!M)return q(new D(F,c));H=M.get("dependencies");if(!H)return q();S=[];for(Q in H)H.hasOwnProperty(Q)&&
S.push({packageId:Q,vers:H[Q]});e(S,function(Y,X){t._ensurePackage(Y.packageId,Y.vers,M,h,X)})(q)})};o.prototype._canonicalPackageId=function(a,b,c){if(a instanceof L)return a.id;if(s(a))return a;if(a==="default"&&this.defaultPackage)return this.defaultPackage.id;var h=this.canonicalPackageIds,q,t,F,H,M;if(!c)c=this.anonymousPackage;if(!c)throw new Error("working package is required");b||(b=c.requiredVersion(a));q=c.id;if(!h)h=this.canonicalPackageIds={};h[q]||(h[q]={});h=h[q];h[a]||(h[a]={});h=h[a];
if(h[b])return h[b];q=this.sources;t=c.canonicalPackageId(a,b);M=c;if(!t)if(t=c.canonicalPackageId(a,null))throw new Error(c.get("name")+" contains an incompatible nested package "+a+" (expected: "+b+")");if(!t&&q){H=q.length;for(F=0;!t&&F<H;F++){M=q[F];t=M.canonicalPackageId(a,b)}}t&&this._cachePackageSource(t,c,M);return h[b]=t};o.prototype._cachePackageSource=function(a,b,c){var h=this.packageSources;b=b.id;if(!h)h=this.packageSources={};h[b]||(h[b]={});h=h[b];h[a]=c};o.prototype._sourceForCanonicalPackageId=
function(a,b){var c=this.packageSources,h=b.id,q,t;if(!c)c=this.packageSources={};c[h]||(c[h]={});c=c[h];if(c[a])return c[a];h=this.sources;if(b)if(q=b.packageFor(a))t=b;if(!t&&h){b=h.length;for(q=0;!t&&q<b;q++){t=h[q];t.packageFor(a)||(t=null)}}return c[a]=t};o.prototype._packageFor=function(a,b){var c,h;if(this.defaultPackage&&a===this.defaultPackage.id)return this.defaultPackage;c=this.packages;if(!c)c=this.packages={};if(c[a])return c[a];if(b=this._sourceForCanonicalPackageId(a,b))h=b.packageFor(a);
return c[a]=h};o.prototype._packageReady=function(a,b,c){var h;if(c[a])return true;c[a]=true;b=this._packageFor(a,b);if(!b)return false;a=b.get("dependencies");for(h in a)if(a.hasOwnProperty(h)){a=a[h];a=this._canonicalPackageId(h,a,b);if(!a)return false;return this._packageReady(a,b,c)}return true};o.prototype._resolve=function(a,b,c){var h,q,t,F;if(a[0]==="/"&&a.indexOf(":")<0)return this.anonymousPackage.id+":"+a;if(a.match(/(^\.\.?\/)|(\/\.\.?\/)|(\/\.\.?\/?$)/)){if((h=a.indexOf(":"))>=0){F=a.slice(0,
h);a=a.slice(h+1);b=[]}else if(a.match(/^\.\.?\//)){if(!b)throw new Error("id required to resolve relative id: "+a);if(b.indexOf(":")>=0)throw new Error("current moduleId cannot contain packageId");if(c)F=c.id;b=b.split("/");b.pop()}else b=[];t=a.split("/");c=t.length;for(h=0;h<c;h++){q=t[h];if(q===".."){if(b.length<1)throw new Error("invalid path: "+a);b.pop()}else q!=="."&&b.push(q)}a=b.join("/");if(F)a=f(F,a)}return a};var y=w.extend(Object);w.Sandbox=y;y.prototype.init=function(a,b,c,h){this.loader=
a;this.env=b;this.args=c;h&&this.main(h);this.clear()};y.prototype.catalogPackages=function(a){return this.loader.catalogPackages(a)};y.prototype.createRequire=function(a){var b=this,c=a.id,h=a.ownerPackage,q=function(t,F){if(F&&t.indexOf(":")<0){if(F.isPackage)F=F.id;t=F+":"+t}return b.require(t,c,h)};a=q.displayName=(c||"(unknown)")+"#require";q.nativeRequire=b.nativeRequire;q.ensure=function(t,F){if(!d(t)){t=Array.prototype.slice.call(arguments);F=t.pop()}e(t,function(H,M){b.ensure(H,c,h,M)})(function(H){if(H)return F(H);
if(F.length<=1)return F();F(null,i(t,function(M){return b.require(M,c,h)}))})};q.ensure.displayName=a+".ensure";q.ready=function(t){var F,H;d(t)||(t=Array.prototype.slice.call(arguments));H=t.length;for(F=0;F<H;F++)if(!b.ready(t[F],c,h))return false;return true};q.ready.displayName=a+".ready";q.packageFor=function(t,F){return b.packageFor(t,F,h)};q.packageFor.displayName=a+".packageFor";q.ensurePackage=function(t,F,H){b.ensurePackage(t,F,h,function(M){if(M)return H(M);if(H.length<=1)return H();H(null,
b.packageFor(t,F,h))})};q.ensurePackage.displayName=a+".ensurePackage.displayName";q.catalogPackages=function(){return b.catalogPackages(h)};q.main=b.main();q.env=b.env;q.args=b.args;q.sandbox=b;q.loader=b.loader;q.isTiki=true;return q};y.prototype.Module=T;y.prototype.module=function(a,b,c){var h,q,t;b=this.loader.canonical(a,b,c);if(!b)throw new D(a,c);h=this.modules;if(!h)h=this.modules={};if(a=h[b])return a;q=b.indexOf(":",2);a=b.slice(q+1);q=b.slice(0,q);t=this.loader.packageFor(q,c);if(!t)throw new D(q,
c);return a=h[b]=new this.Module(a,t,this)};y.prototype.main=function(a,b){if(a!==undefined){this._mainModule=null;this._mainModuleId=a;this._mainModuleWorkingPackage=b;return this}else{if(!this._mainModule&&this._mainModuleId){b=this._mainModuleWorkingPackage;this._mainModule=this.module(this._mainModuleId,b)}return this._mainModule}};y.prototype.require=function(a,b,c){var h,q;b=this.loader.canonical(a,b,c);if(!b)throw new D(a,c);q=this.exports;a=this.usedExports;if(!q)q=this.exports={};if(!a)a=
this.usedExports={};if(h=q[b]){h=h.exports;a[b]||(a[b]=h);return h}h=this.loader.load(b,c,this);if(!h)throw new D(b,c);c=this.module(b,c);q[b]=c;q=h.call(this,c);c.exports=q;if(a[b]&&a[b]!==q)throw new Error("cyclical requires() in "+b);return q};y.prototype.ready=function(a,b,c){return(a=this.loader.canonical(a,b,c))?this.loader.ready(a):false};y.prototype.ensure=function(a,b,c,h){var q,t,F;if(b&&"string"!==typeof b){h=c;c=b;b=null}if(c&&"function"===typeof c){h=c;c=null}b=this.loader.canonical(a,
b,c);if(!b)return h(new D(a,c));F=b.indexOf(":",2);a=b.slice(F+1);t=b.slice(0,F);q=this.loader;q.ensurePackage(t,c,function(H){if(H)return h(H);H=q.packageFor(t,c);H.exists(a)?h():h(new D(a,H))})};y.prototype.packageFor=function(a,b,c){a=this.loader.canonicalPackageId(a,b,c);if(!a)return null;return this.loader.packageFor(a)};y.prototype.ensurePackage=function(a,b,c,h){if(b&&"string"!==typeof b){h=c;c=b;b=null}if(c&&"function"===typeof c){h=c;c=null}b=this.loader.canonicalPackageId(a,b,c);if(!b)return h(new D(a,
c));this.loader.ensurePackage(b,h)};y.prototype.resource=function(a,b,c){if(!c.resource)return null;return c.resource(a,b)};y.prototype.clear=function(){this.exports={};this.modules={};this.usedExports={};return this};var x=w.extend(Object);w.Browser=x;x.prototype.init=function(){this._ready={};this._unload={};this.clear()};x.prototype.clear=function(){this.packageInfoByName={};this.packageInfoById={};this.packages={};this.factories={};this.stylesheetActions={};this.scriptActions={};this.ensureActions=
{}};x.start=function(a,b,c){var h;h=new x;h.loader=new o([h]);h.sandbox=new y(h.loader,a,b);h.queue=c;h.require=h.sandbox.createRequire({id:"index",ownerPackage:h.loader.anonymousPackage});return h};x.prototype.replay=function(){var a=this.queue,b=a?a.length:0,c,h;this.queue=null;for(c=0;c<b;c++){h=a[c];this[h.m].apply(this,h.a)}return this};x.prototype.start=function(){return this};x.prototype.global=function(a){if(!B&&!E)return this;var b=function(){return this}(),c,h,q,t,F,H,M,Q;c=this.globals;
if(!c)c=this.globals={};h=this.packageFor(a);if(!h)throw new Error(a+" package not found");q=h.get("dependencies");if(!q)return this;for(t in q)if(q.hasOwnProperty(t)){a=this.loader.canonical(t,h);if(!c[a]){c[a]=true;if(this.sandbox.ready(t,h)){a=this.sandbox.require(t,h);if(F=a.__globals__){Q=F.length;for(M=0;M<Q;M++){H=F[M];b[H]=a[H]}}else for(H in a)if(a.hasOwnProperty(H))b[H]=a[H]}}}return this};var I=function(a){var b,c;if(a.length===1){b=null;c=a[0];a=Array.prototype.slice.call(a,1)}else{b=
a[0];c=a[1];a=Array.prototype.slice.call(a,2)}return{target:b,method:c,args:a}},O=function(a,b,c){a[b]||(a[b]=[]);a[b].push(I(c))};x.prototype.addReadyListener=function(){if(this._ready&&this._ready.isReady)this._invoke(I(arguments));else{this._setupReadyListener();O(this._ready,"queue",arguments)}};x.prototype.addMainListener=function(){if(this._ready&&this._ready.isReady)this._invoke(I(arguments));else{this._setupReadyListener();O(this._ready,"mqueue",arguments)}};x.prototype.addUnloadListener=
function(){if(this._unload&&this._unload.isUnloading)this._invoke(I(arguments));else{this._setupUnloadListener();O(this._unload,"queue",arguments)}};x.prototype._invoke=function(a){var b=a.target,c=a.method;if("string"===typeof b)b=this.require(b);if("string"===typeof c)c=b[c];c&&c.apply(b,a.args);a.target=a.method=a.args=null};x.prototype._setupReadyListener=function(){if(this._ready.setup)return this;this._ready.setup=true;var a=this._ready,b=this,c;c=function(){if(!a.isReady){a.isReady=true;a.cleanup&&
a.cleanup();a.cleanup=null;var h,q,t;q=(h=a.queue)?h.length:0;a.queue=null;for(t=0;t<q;t++)b._invoke(h[t]);q=(h=a.mqueue)?h.length:0;a.mqueue=null;for(t=0;t<q;t++)b._invoke(h[t]);b._runMain()}};if("undefined"!==typeof document)if(document.addEventListener){a.cleanup=function(){document.removeEventListener("DOMContentLoaded",c,false);document.removeEventListener("load",c,false)};document.addEventListener("DOMContentLoaded",c,false);document.addEventListener("load",c,false)}else if(document.attachEvent){a.cleanup=
function(){document.detachEvent("onreadystatechange",c);document.detachEvent("onload",c);a.ieHandler=null};document.attachEvent("onreadystatechange",c);document.attachEvent("onload",c);if(document.documentElement.doScroll&&window==window.top){a.ieHandler=function(){if(a.ieHandler&&!a.isReady)try{document.documentElement.doScroll("left")}catch(h){setTimeout(a.ieHandler,0);return}c()};a.ieHandler()}}};x._scheduleUnloadListener=function(){if(this._unload.setup)return this;this._unload.setup=true;var a=
this._unload,b=this,c;a.isUnloading=false;c=function(){if(!a.isUnloading){a.isUnloading=true;a.cleanup&&a.cleanup();a.cleanup=null;var h=a.queue,q=h?h.length:0,t;a.queue=null;for(t=0;t<q;t++)b._invoke(h[t])}};if("undefined"!==typeof document)if(document.addEventListener){a.cleanup=function(){document.removeEventListener("unload",c)};document.addEventListener("unload",c,false)}else if(document.attachEvent){a.cleanup=function(){document.detachEvent("onunload",c)};document.attachEvent("unload",c)}};
x.prototype.main=function(a,b){this.sandbox&&this.sandbox.main(a);this._setupReadyListener();this._main={id:a,method:b}};x.prototype._runMain=function(){if(this._main){var a=this._main.id,b=this._main.method,c=this.require;if(a&&c){this._main=null;c.ensure(a,function(h){if(h)throw h;h=c(a);if("string"===typeof b)b=h[b];b&&b.call(h)})}}};x.prototype._action=function(a){var b;return b=r(function(c){b.resolve=function(h,q){b.resolve=null;c(h,q)};a()})};x.prototype._resolve=function(a,b,c){if(a[b])a[b].resolve&&
a[b].resolve(null,c);else a[b]=function(h){h(null,c)};return this};x.prototype._fail=function(a,b,c){a[b].resolve&&a[b].resolve(c)};x.prototype._normalize=function(a,b){s(b)||(b="::"+b);a.id=b;a.version=N.normalize(a.version);a["tiki:external"]=!!a["tiki:external"];a["tiki:private"]=!!a["tiki:private"];var c=a["tiki:base"];if(a["tiki:resources"])a["tiki:resources"]=i(a["tiki:resources"],function(t){if("string"===typeof t)t={id:b+":"+t,name:t};if(!t.name)throw new G(a,"resources must have a name");
if(!t.id)t.id=b+":"+t.name;if(!s(t.id))t.id="::"+t.id;if(!t.type)t.type=t.name.match(/\.js$/)?"script":t.name.match(/\.css$/)?"stylesheet":"resource";if(!t.url)t.url=c?c+"/"+t.name:t.id+t.name;return t});if(!a.dependencies)a.dependencies={};var h=a["tiki:nested"],q;if(h)for(q in h){if(h.hasOwnProperty(q))s(h[q])||(h[q]="::"+h[q])}else a["tiki:nested"]={};return a};x.prototype.register=function(a,b){var c,h,q,t=-1;b=this._normalize(b,a);a=b.id;c=this.packageInfoById;if(!c)c=this.packageInfoById={};
if(c[a]){if(!c[a]["tiki:external"])return this;h=c[a]}c[a]=b;if(b.name){a=b.name;q=b.version;c=this.packageInfoByName;if(!c)c=this.packageInfoByName={};c[a]||(c[a]={});c=c[a];if(!c[q]||c[q].length<=1)c[q]=[b];else{if(h)t=c[q].indexOf(h);if(t>=0)c[q]=c[q].slice(0,t).concat(c[q].slice(t+1));c[q].push(b)}}return this};x.prototype.module=function(a,b){s(a)||(a="::"+a);this.factories[a]=b;return this};x.prototype.script=function(a){s(a)||(a="::"+a);this._resolve(this.scriptActions,a,true)};x.prototype.stylesheet=
function(a){s(a)||(a="::"+a);this._resolve(this.stylesheetActions,a,true)};var B="undefined"!==typeof document&&document.createElement,E="undefined"!==typeof XMLHttpRequest;x.prototype.xhr=!B;x.prototype.autowrap=false;var J=function(a){if(!a)return null;for(var b=a.length;--b>=0;)if(!a[b]["tiki:private"])return a[b];return null};x.prototype.canonicalPackageId=function(a,b){a=this.packageInfoByName[a];var c,h,q;if(b)b=N.normalize(b);if(!a)return null;if(a[b]&&a[b].length===1)return a[b][0].id;for(h in a)if(a.hasOwnProperty(h))if(N.compatible(b,
h))if(!c||N.compare(q,h)<0)if(c=J(a[h]))q=h;return c?c.id:null};x.prototype.packageFor=function(a){var b=this.packages[a];if(b)return b;if((b=this.packageInfoById[a])&&!b["tiki:external"]){b=new this.Package(a,b,this);return this.packages[a]=b}return null};x.prototype.ensurePackage=function(a,b){var c=this.ensureActions[a];if(c)return c(b);var h=this.packageInfoById[a];if(!h)return b(new D(a,"browser package info"));var q=this;c=r(function(t){var F=1,H=false,M,Q=function(Z){if(!M){if(Z){M=true;return t(Z)}F-=
1;if(F<=0&&H)return t(null,h)}},S=h.dependencies,Y=h["tiki:nested"],X,W;for(X in S)if(S.hasOwnProperty(X)){W=Y[X];if(!W){W=S[X];W=q.canonicalPackageId(X,W)}if(W&&q.packageInfoById[a]){F++;q.ensurePackage(W,Q)}}Y=(S=h["tiki:resources"])?S.length:0;for(X=0;X<Y;X++){W=S[X];if(W.type!=="resource")if(W.type==="script"){F++;q.ensureScript(W.id,W.url,Q)}else if(W.type==="stylesheet"){F++;q.ensureStylesheet(W.id,W.url,Q)}}H=true;Q()});this.ensureActions[a]=c;c(b)};x.prototype.ensureScript=function(a,b,c){var h=
this.scriptActions[a];if(h)return h(c);var q=this;h=this._action(function(){q._loadScript(a,b)});this.scriptActions[a]=h;return h(c)};x.prototype.ensureStylesheet=function(a,b,c){var h=this.stylesheetActions[a];if(h)return h(c);var q=this;h=this._action(function(){q._loadStylesheet(a,b)});this.stylesheetActions[a]=h;return h(c)};x.prototype._injectScript=function(a,b){var c;a=document.body;c=document.createElement("script");c.src=b;a.appendChild(c)};x.prototype._xhrScript=function(a,b){var c=this.autowrap,
h=new XMLHttpRequest;h.open("GET",b,true);h.onreadystatechange=function(){if(!(h.readyState!==4||h.status!==200&&h.status!==0)){var q=h.responseText;if(c)q="tiki.module('"+a+"', function(require, exports, module) {"+q+"});tiki.script('"+a+"');";eval(q+"\n//@ sourceURL="+b)}};h.send(null)};x.prototype._loadScript=function(a,b){if(this.autowrap){this.xhr=true;E||l("Autowrap is on but XHR is not available. Danger ahead.")}if(E&&B)if(this.xhr)try{return this._xhrScript(a,b)}catch(c){return this._injectScript(a,
b)}else try{return this._injectScript(a,b)}catch(h){return this._xhrScript(a,b)}else if(E)return this._xhrScript(a,b);else if(B)return this._injectScript(a,b);l("Browser#_loadScript() not supported on this platform.");this.script(a)};x.prototype._loadStylesheet=B?function(a,b){var c,h;c=document.getElementsByTagName("head")[0]||document.body;h=document.createElement("link");h.rel="stylesheet";h.href=b;h.type="text/css";c.appendChild(h);this.stylesheet(a)}:function(a){l("Browser#_loadStylesheet() not supported on this platform.");
this.stylesheet(a)};T=L.extend();x.prototype.Package=T;T.prototype.init=function(a,b,c){L.prototype.init.call(this,a,b);this.source=c};T.prototype.canonicalPackageId=function(a,b){var c;if(c=L.prototype.canonicalPackageId.call(this,a,b))return c;c=(this.get("tiki:nested")||{})[a];if(!c)return null;return(a=this.source.packageInfoById[c])&&N.compatible(b,a.version)?c:null};T.prototype.packageFor=function(a){var b=L.prototype.packageFor.call(this,a);return b?b:this.source.packageFor(a)};T.prototype.ensurePackage=
function(a,b){if(a===this.id)return b();this.source.ensurePackage(a,b)};T.prototype.catalogPackages=function(){var a=[this],b,c;b=this.get("tiki:nested")||{};for(c in b)b.hasOwnProperty(c)&&a.push(this.source.packageFor(b[c]));return a};T.prototype.exists=function(a){return!!this.source.factories[this.id+":"+a]};T.prototype.load=function(a){var b;return(b=this.source.factories[this.id+":"+a])?new this.Factory(a,this,b):null};T.prototype.Factory=U;v(w,"tiki")});u=u.start();u.replay();bespin.tiki=u})();
bespin.tiki.register("::bespin",{name:"bespin",dependencies:{}});bespin.bootLoaded=true;
bespin.tiki.module("bespin:builtins",function(u,j){j.metadata={bespin:{provides:[{ep:"extensionpoint",name:"extensionpoint",indexOx:"name",register:"plugins#registerExtensionPoint",unregister:"plugins#unregisterExtensionPoint",description:"Defines a new extension point",params:[{name:"name",type:"string",description:"the extension point's name",required:true},{name:"description",type:"string",description:"description of what the extension point is for"},{name:"params",type:"array of objects",description:"parameters that provide the metadata for a given extension. Each object should have name and description, minimally. It can also have a 'type' (eg string, pointer, or array) and required to denote whether or not this parameter must be present on the extension."},
{name:"indexOn",type:"string",description:"You can provide an 'indexOn' property to name a property of extensions through which you'd like to be able to easily look up the extension."},{name:"register",type:"pointer",description:"function that is called when a new extension is discovered. Note that this should be used sparingly, because it will cause your plugin to be loaded whenever a matching plugin appears."},{name:"unregister",type:"pointer",description:"function that is called when an extension is removed. Note that this should be used sparingly, because it will cause your plugin to be loaded whenever a matching plugin appears."}]},
{ep:"extensionpoint",name:"extensionhandler",register:"plugins#registerExtensionHandler",unregister:"plugins#unregisterExtensionHandler",description:"Used to attach listeners ",params:[{name:"name",type:"string",description:"name of the extension point to listen to",required:true},{name:"register",type:"pointer",description:"function that is called when a new extension is discovered. Note that this should be used sparingly, because it will cause your plugin to be loaded whenever a matching plugin appears."},
{name:"unregister",type:"pointer",description:"function that is called when an extension is removed. Note that this should be used sparingly, because it will cause your plugin to be loaded whenever a matching plugin appears."}]},{ep:"extensionpoint",name:"factory",description:"Provides a factory for singleton components. Each extension needs to provide a name, a pointer and an action. The action can be 'call' (if the pointer refers to a function), 'new' (if the pointer refers to a traditional JS object) or 'value' (if the pointer refers to the object itself that is the component).",
indexOn:"name"},{ep:"factory",name:"hub",action:"create",pointer:"util/hub#Hub"},{ep:"extensionpoint",name:"command",description:"Editor commands/actions. TODO: list parameters here."}]}}});
bespin.tiki.module("bespin:console",function(u,j){u=u("util/util");var w=function(){},A=["assert","count","debug","dir","dirxml","error","group","groupEnd","info","log","profile","profileEnd","time","timeEnd","trace","warn"];if(typeof window==="undefined"){var s={};A.forEach(function(l){s[l]=function(){var d=Array.prototype.slice.call(arguments);postMessage(JSON.stringify({op:"log",method:l,args:d}))}});j.console=s}else if(u.isSafari||u.isChrome)j.console=window.console;else{j.console={};A.forEach(function(l){j.console[l]=
window.console&&window.console[l]?window.console[l].bind(window.console):w})}});
bespin.tiki.module("bespin:globals",function(){if(!Object.defineProperty)Object.defineProperty=function(u,j,w){var A=Object.prototype.hasOwnProperty;if(typeof w=="object"&&u.__defineGetter__){if(A.call(w,"value")){if(!u.__lookupGetter__(j)&&!u.__lookupSetter__(j))u[j]=w.value;if(A.call(w,"get")||A.call(w,"set"))throw new TypeError("Object doesn't support this action");}else typeof w.get=="function"&&u.__defineGetter__(j,w.get);typeof w.set=="function"&&u.__defineSetter__(j,w.set)}return u};if(!Object.defineProperties)Object.defineProperties=
function(u,j){for(var w in j)Object.prototype.hasOwnProperty.call(j,w)&&Object.defineProperty(u,w,j[w]);return u};(function(){if(!Array.isArray)Array.isArray=function(u){return u&&Object.prototype.toString.call(u)=="[object Array]"};if(!Object.keys)Object.keys=function(u){var j,w=[];for(j in u)u.hasOwnProperty(j)&&w.push(j);return w};if(!Function.prototype.bind)Function.prototype.bind=function(){var u=Array.prototype.slice.call(arguments),j=this,w=function(){return j.call.apply(j,u.concat(Array.prototype.slice.call(arguments)))};
w.name=this.name;w.displayName=this.displayName;w.length=this.length;w.unbound=j;return w}})()});bespin.tiki.module("bespin:index",function(u,j){j.versionNumber="tip";j.versionCodename="DEVELOPMENT MODE";j.apiVersion="dev"});
bespin.tiki.module("bespin:plugins",function(u,j){u("globals");var w=u("promise").Promise,A=u("promise").group,s=u("builtins"),l=u("console").console,d=u("util/util");u("util/stacktrace");var g=u("proxy"),k=u.loader.sources[0],z=function(e,i){if(i){i=i.split("#");return{modName:i[0]?e+":"+i[0]:e,objName:i[1]}}},p=function(e){var i=u(e.modName);if(e.objName)return i[e.objName];return i};j.Extension=function(e){this.pluginName=null;for(property in e)if(e.hasOwnProperty(property))this[property]=e[property];
this._observers=[]};j.Extension.prototype={load:function(e,i,r){r=r||j.catalog;var v=new w,D=function(K){e&&e(K);v.resolve(K)};i=this[i||"pointer"];if(d.isFunction(i)){D(i);return v}var G=z(this.pluginName,i);if(!G){l.error("Extension cannot be loaded because it has no 'pointer'");l.log(this);v.reject(new Error("Extension has no 'pointer' to call"));return v}var P=this.pluginName;r.loadPlugin(P).then(function(){u.ensure(G.modName,function(){var K=p(G);D(K)})},function(K){l.error("Failed to load plugin ",
P,K)});return v},observe:function(e,i,r){this._observers.push({plugin:e,callback:i,property:r});this.load(i,r)},getPluginName:function(){return this.pluginName},_getLoaded:function(e){e=this._getPointer(e);return p(e)}};j.ExtensionPoint=function(e,i){this.name=e;this.catalog=i;this.indexOn=this.pluginName=undefined;this.extensions=[];this.handlers=[]};j.ExtensionPoint.prototype={getImplementingPlugins:function(){var e={};this.extensions.forEach(function(r){e[r.pluginName]=true});var i=Object.keys(e);
i.sort();return i},getDefiningPluginName:function(){return this.pluginName},getByKey:function(e){var i=this.indexOn;if(i)for(var r=0;r<this.extensions.length;r++)if(this.extensions[r][i]==e)return this.extensions[r]},register:function(e){var i=this.catalog;this.extensions.push(e);this.handlers.forEach(function(r){r.register&&r.load(function(v){v?v(e,i):l.error("missing register function for pluginName=",e.pluginName,", extension=",e.name)},"register",i)})},unregister:function(e){var i=this.catalog;
this.extensions.splice(this.extensions.indexOf(e),1);this.handlers.forEach(function(r){r.unregister&&r.load(function(v){v?v(e,i):l.error("missing unregister function for pluginName=",e.pluginName,", extension=",e.name)},"unregister",i)})},orderExtensions:function(e){for(var i=[],r=0;r<e.length;r++)for(var v=0;v!=this.extensions.length;)if(this.extensions[v].pluginName===e[r]){i.push(this.extensions[v]);this.extensions.splice(v,1)}else v++;this.extensions=i.concat(this.extensions)}};j.Plugin=function(e){this.name=
this.catalog=null;this.provides=[];this.stylesheets=[];this.reloadPointer=this.reloadURL=null;for(property in e)if(e.hasOwnProperty(property))this[property]=e[property]};j.Plugin.prototype={register:function(){this.provides.forEach(function(e){this.catalog.getExtensionPoint(e.ep,true).register(e)},this)},unregister:function(){this.provides.forEach(function(e){this.catalog.getExtensionPoint(e.ep,true).unregister(e)},this)},_getObservers:function(){var e={};this.provides.forEach(function(i){l.log("ep: ",
i.ep);l.log(i._observers);e[i.ep]=i._observers});return e},_findDependents:function(e,i,r){var v=this.name,D=this;e.forEach(function(G){if(G!=v){var P=D.catalog.plugins[G];if(P&&P.dependencies)for(dependName in P.dependencies)if(dependName==v&&!i[G]){i[G]={keepModule:false};r||P._findDependents(e,i)}}})},_cleanup:function(e){this.stylesheets.forEach(function(P){for(var K=document.getElementsByTagName("link"),R=0;R<K.length;R++)if(K[R].href.indexOf(P.url)!=-1){K[R].parentNode.removeChild(K[R]);break}});
var i=this.name,r=new RegExp("^"+i+"$"),v=new RegExp("^::"+i+":");i=new RegExp("^::"+i+"$");var D=u.sandbox,G=u.loader;if(!e){C(v,G.factories);C(i,G.canonicalIds);C(i,G.canonicalPackageIds);C(i,G.packageSources);C(i,G.packages);C(r,k.packageInfoByName);C(v,k.factories);C(v,k.scriptActions);C(v,k.stylesheetActions);C(i,k.packages);C(i,k.ensureActions);C(i,k.packageInfoById)}C(v,D.exports);C(v,D.modules);C(v,D.usedExports)},reload:function(e){if(this.reloadURL){if(this.reloadPointer){var i=z(this.name,
this.reloadPointer);if(func=p(i))func();else{l.error("Reload function could not be loaded. Aborting reload.");return}}var r={};this._findDependents(Object.keys(this.catalog.plugins),r);var v={pluginName:this.name,dependents:r};for(var D in r){i=this.catalog.plugins[D];if(i.preRefresh){i=z(D,i.preRefresh);if(func=p(i))r[D]=func(v)}}this.unregister();for(D in r)this.catalog.plugins[D].unregister();this._cleanup(this.name);i=[];var G=u.sandbox,P=Object.keys(G.modules),K=P.length,R=[];for(D in r)r[D].keepModule||
R.push(new RegExp("^::"+D+":"));for(var m=new RegExp("^::"+this.name+":");--K>=0;){var N=P[K];if(m.exec(N))i.push(N);else for(var U=R.length;--U>=0;)if(R[U].exec(N)){i.push(N);break}}i.forEach(function(V){delete G.exports[V];delete G.modules[V];delete G.usedExports[V]});i=function(){this.catalog.loadPlugin(this.name).then(function(){for(D in r)this.catalog.plugins[D].register();for(D in r)if(r[D].callPointer){var V=z(D,r[D].callPointer);(V=p(V))&&V(v)}e&&e()}.bind(this))}.bind(this);P=function(){l.error("Failed to load metadata from "+
this.reloadURL)}.bind(this);this.catalog.loadMetadataFromURL(this.reloadURL).then(i,P)}}};var n=function(e,i,r){i=i.split(".");e=e;var v=i.length-1;if(v>0)for(var D=0;D<v;D++)e=e[i[D]];e[v]=r};j.Catalog=function(){this.points={};this.plugins={};this.metadata={};this.USER_DEACTIVATED="USER";this.DEPENDS_DEACTIVATED="DEPENDS";this.deactivatedPlugins={};this._extensionsOrdering=[];this.instances={};this.instancesLoadPromises={};this._objectDescriptors={};this.children=[];this.getExtensionPoint("extensionpoint",
true).indexOn="name";this.registerMetadata(s.metadata)};j.Catalog.prototype={shareExtension:function(e){return this.plugins[e.pluginName].share},isPluginLoaded:function(e){return Object.keys(u.sandbox.usedExports).some(function(i){return i.indexOf("::"+e+":")==0})},registerObject:function(e,i){this._objectDescriptors[e]=i},_setObject:function(e,i){this.instances[e]=i},createObject:function(e){if(this.instancesLoadPromises[e]!==undefined)return this.instancesLoadPromises[e];var i=this._objectDescriptors[e];
if(i===undefined)throw new Error('Tried to create object "'+e+'" but that object is not registered.');var r=i.factory||e,v=this.getExtensionByKey("factory",r);if(v===undefined)throw new Error('When creating object "'+e+'", there is no factory called "'+r+'" available."');if(this.parent&&this.shareExtension(v))return this.instancesLoadPromises[e]=this.parent.createObject(e);var D=this.instancesLoadPromises[e]=new w,G=i.arguments||[];r=[];if(i.objects){i=i.objects;for(var P in i){var K=this.createObject(i[P]);
r.push(K);K.location=P;K.then(function(R){n(G,K.location,R)})}}A(r).then(function(){v.load().then(function(R){var m=v.action;if(m==="call")R=R.apply(R,G);else if(m==="new"){if(G.length>1){D.reject(new Error("For object "+e+", create a simple factory function and change the action to call because JS cannot handle this case."));return}R=new R(G[0])}else if(m==="value")R=R;else{D.reject(new Error("Create action must be call|new|value. Found"+m));return}this.instances[e]=R;D.resolve(R)}.bind(this))}.bind(this));
return D},getObject:function(e){return this.instances[e]||(this.parent?this.parent.getObject(e):undefined)},getExtensionPoint:function(e,i){if(i&&this.points[e]===undefined)this.points[e]=new j.ExtensionPoint(e,this);return this.points[e]},getExtensions:function(e){e=this.getExtensionPoint(e);if(e===undefined)return[];return e.extensions},orderExtensions:function(e){e=e||this._extensionsOrdering;for(name in this.points)this.points[name].orderExtensions(e);this._extensionsOrdering=e},getExtensionsOrdering:function(){return this._extensionsOrdering},
getExtensionByKey:function(e,i){e=this.getExtensionPoint(e);if(e!==undefined)return e.getByKey(i)},_toposort:function(e){var i=[],r={},v=function(G){if(!(G in r||!(G in e))){r[G]=true;var P=e[G].dependencies;if(!d.none(P))for(var K in P)v(K);i.push(G)}};for(var D in e)v(D);return i},registerMetadata:function(e){if(this.parent)this.parent.registerMetadata(e);else{for(var i in e){var r=e[i];if(r.errors){l.error("Plugin ",i," has errors:");r.errors.forEach(function(v){l.error(v)});delete e[i]}else{if(r.dependencies)r.depends=
Object.keys(r.dependencies);r.name=i;r.version=null;k.canonicalPackageId(i)===null&&k.register("::"+i,r)}}d.mixin(this.metadata,d.clone(e,true));this.children.forEach(function(v){v._registerMetadata(d.clone(e,true))});this._registerMetadata(d.clone(e,true))}},_registerMetadata:function(e){var i,r=this.plugins;this._toposort(e).forEach(function(v){if(this.plugins[v])if(this.isPluginLoaded(v))return;else{var D=this.plugins[v];D.unregister()}var G=e[v],P=!this.deactivatedPlugins[v];if(P&&G.depends&&
G.depends.length!=0)if(!G.depends.some(function(m){return!this.deactivatedPlugins[m]},this)){this.deactivatedPlugins[v]="DEPENDS";P=false}G.catalog=this;G.name=v;D=new j.Plugin(G);r[v]=D;if(G.provides){D=G.provides;for(G=0;G<D.length;G++){var K=new j.Extension(D[G]);K.pluginName=v;D[G]=K;var R=K.ep;if(R=="extensionpoint"&&K.name=="extensionpoint")j.registerExtensionPoint(K,this,false);else if(P)this.getExtensionPoint(K.ep,true).register(K);else R=="extensionpoint"&&j.registerExtensionPoint(K,this,
true)}}else G.provides=[]},this);for(i in e)this._checkLoops(i,r,[]);this.orderExtensions()},loadPlugin:function(e){var i=new w,r=this.plugins[e];if(r.objects){var v=[];r.objects.forEach(function(D){v.push(this.createObject(D))}.bind(this));A(v).then(function(){u.ensurePackage(e,function(){i.resolve()})})}else u.ensurePackage(e,function(D){D?i.reject(D):i.resolve()});return i},loadMetadataFromURL:function(e){var i=new w;g.xhr("GET",e,true).then(function(r){this.registerMetadata(JSON.parse(r));i.resolve()}.bind(this),
function(r){i.reject(r)});return i},deactivatePlugin:function(e,i){var r=this.plugins[e];if(!r){i||(this.deactivatedPlugins[e]="USER");return'There is no plugin named "'+e+'" in this catalog.'}if(this.deactivatedPlugins[e]){i||(this.deactivatedPlugins[e]="USER");return'The plugin "'+e+'" is already deactivated'}this.deactivatedPlugins[e]=i?"DEPENDS":"USER";var v={},D=[];r._findDependents(Object.keys(this.plugins),v,true);Object.keys(v).forEach(function(G){G=this.deactivatePlugin(G,true);if(Array.isArray(G))D=
D.concat(G)},this);r.unregister();i&&D.push(e);return D},activatePlugin:function(e,i){var r=this.plugins[e];if(!r)return'There is no plugin named "'+e+'" in this catalog.';if(!this.deactivatedPlugins[e])return'The plugin "'+e+'" is already activated';if(!(i&&this.deactivatedPlugins[e]==="USER")){if(r.depends&&r.depends.length!=0)if(!r.depends.some(function(G){return!this.deactivatedPlugins[G]},this)){this.deactivatedPlugins[e]="DEPENDS";return'Can not activate plugin "'+e+'" as some of its dependent plugins are not activated'}r.register();
this.orderExtensions();delete this.deactivatedPlugins[e];var v=[],D={};r._findDependents(Object.keys(this.plugins),D,true);Object.keys(D).forEach(function(G){G=this.activatePlugin(G,true);if(Array.isArray(G))v=v.concat(G)},this);i&&v.push(e);return v}},removePlugin:function(e){var i=this.plugins[e];if(i==undefined)throw new Error("Attempted to remove plugin "+e+" which does not exist.");i.unregister();i._cleanup(true);delete this.metadata[e];delete this.plugins[e]},getResourceURL:function(e){var i=
document.getElementById("bespin_base"),r="";if(i){r+=i.href;d.endsWith(r,"/")||(r+="/")}e=this.plugins[e];if(e!=undefined)return r+e.resourceURL},_checkLoops:function(e,i,r){var v=false;r.forEach(function(P){if(e===P){l.error("Circular dependency",e,r);v=true}});if(v)return true;r.push(e);if(i[e]){if(i[e].dependencies)for(var D in i[e].dependencies){var G=r.slice();if(this._checkLoops(D,i,G)){l.error("Errors found when looking at ",e);return true}}}else l.error("Missing metadata for ",e);return false},
getPlugins:function(e){var i=[],r=e.onlyType;for(var v in this.plugins){var D=this.plugins[v];r&&D.type&&D.type!=r||D.name=="bespin"||i.push(D)}var G=e.sortBy;G||(G=["name"]);i.sort(function(P,K){for(var R=0;R<G.length;R++){v=G[R];if(P[v]<K[v])return-1;else if(K[v]<P[v])return 1}return 0});return i},loadObjectForPropertyPath:function(e,i){var r=new w,v=/^([^:]+):([^#]+)#(.*)$/.exec(e);if(v===null)throw new Error("loadObjectForPropertyPath: malformed path: '"+e+"'");v=v[1];if(v===""){if(d.none(i))throw new Error("loadObjectForPropertyPath: no plugin name supplied and no context is present");
v=i}u.ensurePackage(v,function(){r.resolve(this.objectForPropertyPath(e))}.bind(this));return r},objectForPropertyPath:function(e,i,r){r=r==undefined?e.length:r;i||(i=window);var v=e.split("#");if(v.length!==1){i=u(v[0]);if(i===undefined)return;e=v[1];i=i;r-=v[0].length}for(var D=0;i&&D<r;){v=e.indexOf(".",D);if(v<0||v>r)v=r;D=e.slice(D,v);i=i[D];D=v+1}if(D<r)i=undefined;return i},publish:function(e,i,r,v){if(this.shareExtension(this.getExtensionPoint(i)))if(this.parent)this.parent.publish(e,i,r,
v);else{this.children.forEach(function(D){D._publish(e,i,r,v)});this._publish(e,i,r,v)}else this._publish(e,i,r,v)},_publish:function(e,i,r,v){this.getExtensions(i).forEach(function(D){if(D.match&&!D.regexp)D.regexp=new RegExp(D.match);if(D.regexp&&D.regexp.test(r)||D.key===r||d.none(D.key)&&d.none(r))D.load().then(function(G){G(e,r,v)})})},registerExtension:function(e,i){i=new j.Extension(i);i.pluginName="__dynamic";this.getExtensionPoint(e).register(i)}};j.registerExtensionPoint=function(e,i,r){var v=
i.getExtensionPoint(e.name,true);v.description=e.description;v.pluginName=e.pluginName;v.params=e.params;if(e.indexOn)v.indexOn=e.indexOn;if(!r&&(e.register||e.unregister))j.registerExtensionHandler(e,i)};j.registerExtensionHandler=function(e,i){if(!(i.parent&&i.shareExtension(e))){var r=i.getExtensionPoint(e.name,true);r.handlers.push(e);if(e.register){var v=d.clone(r.extensions);e.load(function(D){if(!D)throw e.name+" is not ready";v.forEach(function(G){D(G,i)})},"register",i)}}};j.unregisterExtensionPoint=
function(e){if(e.register||e.unregister)j.unregisterExtensionHandler(e)};j.unregisterExtensionHandler=function(e,i){if(!(i.parent&&i.shareExtension(e))){i=i.getExtensionPoint(e.name,true);if(i.handlers.indexOf(e)!=-1){i.handlers.splice(i.handlers.indexOf(e),1);if(e.unregister){var r=d.clone(i.extensions);e.load(function(v){if(!v)throw e.name+" is not ready";r.forEach(function(D){v(D)})},"unregister")}}}};j.catalog=new j.Catalog;var C=function(e,i){for(var r=Object.keys(i),v=r.length;--v>0;)e.exec(r[v])&&
delete i[r[v]]};j.getUserPlugins=function(){return j.catalog.getPlugins({onlyType:"user"})}});
bespin.tiki.module("bespin:promise",function(u,j){var w=u("bespin:console").console;u("bespin:util/stacktrace");var A=0;j._outstanding=[];j._recent=[];j.Promise=function(){this._status=0;this._value=undefined;this._onSuccessHandlers=[];this._onErrorHandlers=[];this._id=A++;j._outstanding[this._id]=this};j.Promise.prototype.isPromise=true;j.Promise.prototype.isComplete=function(){return this._status!=0};j.Promise.prototype.isResolved=function(){return this._status==1};j.Promise.prototype.isRejected=
function(){return this._status==-1};j.Promise.prototype.then=function(s,l){if(typeof s==="function")if(this._status===1)s.call(null,this._value);else this._status===0&&this._onSuccessHandlers.push(s);if(typeof l==="function")if(this._status===-1)l.call(null,this._value);else this._status===0&&this._onErrorHandlers.push(l);return this};j.Promise.prototype.chainPromise=function(s){var l=new j.Promise;l._chainedFrom=this;this.then(function(d){try{l.resolve(s(d))}catch(g){l.reject(g)}},function(d){l.reject(d)});
return l};j.Promise.prototype.resolve=function(s){return this._complete(this._onSuccessHandlers,1,s,"resolve")};j.Promise.prototype.reject=function(s){return this._complete(this._onErrorHandlers,-1,s,"reject")};j.Promise.prototype._complete=function(s,l,d,g){if(this._status!=0){w.group("Promise already closed");w.error("Attempted "+g+"() with ",d);w.error("Previous status = ",this._status,", previous value = ",this._value);w.trace();if(this._completeTrace){w.error("Trace of previous completion:");
this._completeTrace.log(5)}w.groupEnd();return this}this._status=l;this._value=d;s.forEach(function(k){k.call(null,this._value)},this);this._onSuccessHandlers.length=0;this._onErrorHandlers.length=0;delete j._outstanding[this._id];for(j._recent.push(this);j._recent.length>20;)j._recent.shift();return this};j.group=function(s){s instanceof Array||(s=Array.prototype.slice.call(arguments));if(s.length===0)return(new j.Promise).resolve([]);var l=new j.Promise,d=[],g=0,k=function(z){return function(p){d[z]=
p;g++;l._status!==-1&&g===s.length&&l.resolve(d)}};s.forEach(function(z,p){p=k(p);var n=l.reject.bind(l);z.then(p,n)});return l};j.synchronizer=function(s,l){return function(){var d=s.apply(l,arguments);if(!d.isComplete())throw new Error("asynchronous function can't be synchronized");return d._value}}});
bespin.tiki.module("bespin:proxy",function(u,j){u("util/util");var w=u("promise").Promise;j.xhr=function(A,s,l,d){var g=new w;if(!bespin.proxy||!bespin.proxy.xhr){var k=new XMLHttpRequest;k.onreadystatechange=function(){if(k.readyState===4){var z=k.status;if(z!==0&&z!==200){z=new Error(k.responseText+" (Status "+k.status+")");z.xhr=k;g.reject(z)}else g.resolve(k.responseText)}}.bind(this);k.open("GET",s,l);d&&d(k);k.send()}else bespin.proxy.xhr.call(this,A,s,l,d,g);return g};j.Worker=function(A){return!bespin.proxy||
!bespin.proxy.worker?new Worker(A):new bespin.proxy.worker(A)}});
bespin.tiki.module("bespin:sandbox",function(u,j){var w=u("tiki"),A=u("bespin:util/util"),s=u("bespin:plugins").catalog;if(s.parent)throw new Error("The sandbox module can't be used inside of a slave catalog!");u=function(){w.Sandbox.call(this,bespin.tiki.require.loader,{},[]);var l=this.require("bespin:plugins").catalog;l.parent=s;s.children.push(l);l.deactivatePlugin=A.clone(s.deactivatePlugin);l._extensionsOrdering=A.clone(s._extensionsOrdering);l._registerMetadata(A.clone(s.metadata,true))};u.prototype=
new w.Sandbox;u.prototype.require=function(l,d,g){var k=this.loader.canonical(l,d,g).substring(2).split(":")[0];return s.plugins[k].share?bespin.tiki.sandbox.require(l,d,g):w.Sandbox.prototype.require.call(this,l,d,g)};j.Sandbox=u});
bespin.tiki.module("bespin:util/cookie",function(u,j){var w=function(A,s){return A.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,function(l){if(s&&s.indexOf(l)!=-1)return l;return"\\"+l})};j.get=function(A){A=new RegExp("(?:^|; )"+w(A)+"=([^;]*)");return(A=document.cookie.match(A))?decodeURIComponent(A[1]):undefined};j.set=function(A,s,l){l=l||{};if(typeof l.expires=="number"){var d=new Date;d.setTime(d.getTime()+l.expires*24*60*60*1E3);l.expires=d}if(l.expires&&l.expires.toUTCString)l.expires=l.expires.toUTCString();
s=encodeURIComponent(s);A=A+"="+s;var g;for(g in l){A+="; "+g;s=l[g];if(s!==true)A+="="+s}document.cookie=A};j.remove=function(A){j.set(A,"",{expires:-1})};j.isSupported=function(){if(!("cookieEnabled"in navigator)){j.set("__djCookieTest__","CookiesAllowed");navigator.cookieEnabled=j.get("__djCookieTest__")=="CookiesAllowed";navigator.cookieEnabled&&j.remove("__djCookieTest__")}return navigator.cookieEnabled}});
bespin.tiki.module("bespin:util/scratchcanvas",function(u,j){var w=u("bespin:util/util"),A=function(){this._canvas=document.getElementById("bespin-scratch-canvas");if(w.none(this._canvas)){this._canvas=document.createElement("canvas");this._canvas.id="bespin-scratch-canvas";this._canvas.width=400;this._canvas.height=300;this._canvas.style.position="absolute";this._canvas.style.top="-10000px";this._canvas.style.left="-10000px";document.body.appendChild(this._canvas)}};A.prototype.getContext=function(){return this._canvas.getContext("2d")};
A.prototype.measureStringWidth=function(l,d){if(w.none(d))d="M";var g=this.getContext();g.save();g.font=l;l=g.measureText(d).width;g.restore();return l};var s=null;j.get=function(){if(s===null)s=new A;return s}});
bespin.tiki.module("bespin:util/stacktrace",function(u,j){function w(p){for(var n=0;n<p.length;++n){var C=p[n];if(typeof C=="object")p[n]="#object";else if(typeof C=="function")p[n]="#function";else if(typeof C=="string")p[n]='"'+C+'"'}return p.join(",")}function A(){}var s=u("bespin:util/util"),l=u("bespin:console").console,d=function(){if(s.isMozilla)return"firefox";else if(s.isOpera)return"opera";else if(s.isSafari)return"other";try{0()}catch(p){if(p.arguments)return"chrome";if(p.stack)return"firefox";
if(window.opera&&!("stacktrace"in p))return"opera"}return"other"}(),g={chrome:function(p){var n=p.stack;if(!n){l.log(p);return[]}return n.replace(/^.*?\n/,"").replace(/^.*?\n/,"").replace(/^.*?\n/,"").replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@").split("\n")},firefox:function(p){var n=p.stack;if(!n){l.log(p);return[]}n=n.replace(/(?:\n@:0)?\s+$/m,"");n=n.replace(/^\(/gm,"{anonymous}(");return n.split("\n")},opera:function(p){p=p.message.split("\n");
var n=/Line\s+(\d+).*?script\s+(http\S+)(?:.*?in\s+function\s+(\S+))?/i,C,e,i;C=4;e=0;for(i=p.length;C<i;C+=2)if(n.test(p[C]))p[e++]=(RegExp.$3?RegExp.$3+"()@"+RegExp.$2+RegExp.$1:"{anonymous}()@"+RegExp.$2+":"+RegExp.$1)+" -- "+p[C+1].replace(/^\s+/,"");p.splice(e,p.length-e);return p},other:function(p){for(var n=/function\s*([\w\-$]+)?\s*\(/i,C=[],e=0,i,r;p&&C.length<10;){i=n.test(p.toString())?RegExp.$1||"{anonymous}":"{anonymous}";r=Array.prototype.slice.call(p.arguments);C[e++]=i+"("+w(r)+")";
if(p===p.caller&&window.opera)break;p=p.caller}return C}};A.prototype={sourceCache:{},ajax:function(p){var n=this.createXMLHTTPObject();if(n){n.open("GET",p,false);n.setRequestHeader("User-Agent","XMLHTTP/1.0");n.send("");return n.responseText}},createXMLHTTPObject:function(){for(var p,n=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],C=0;C<
n.length;C++)try{p=n[C]();this.createXMLHTTPObject=n[C];return p}catch(e){}},getSource:function(p){p in this.sourceCache||(this.sourceCache[p]=this.ajax(p).split("\n"));return this.sourceCache[p]},guessFunctions:function(p){for(var n=0;n<p.length;++n){var C=p[n],e=/{anonymous}\(.*\)@(\w+:\/\/([-\w\.]+)+(:\d+)?[^:]+):(\d+):?(\d+)?/.exec(C);if(e){var i=e[1];e=e[4];if(i&&e){i=this.guessFunctionName(i,e);p[n]=C.replace("{anonymous}",i)}}}return p},guessFunctionName:function(p,n){try{return this.guessFunctionNameFromLines(n,
this.getSource(p))}catch(C){return"getSource failed with url: "+p+", exception: "+C.toString()}},guessFunctionNameFromLines:function(p,n){for(var C=/function ([^(]*)\(([^)]*)\)/,e=/['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*(function|eval|new Function)/,i="",r=0;r<10;++r){i=n[p-r]+i;if(i!==undefined){var v=e.exec(i);if(v)return v[1];else v=C.exec(i);if(v&&v[1])return v[1]}}return"(?)"}};var k=new A,z=[/http:\/\/localhost:4020\/sproutcore.js:/];j.ignoreFramesMatching=function(p){z.push(p)};j.Trace=function(p,
n){this._ex=p;this._stack=g[d](p);if(n)this._stack=k.guessFunctions(this._stack)};j.Trace.prototype.log=function(p){if(p<=0)p=999999999;for(var n=0,C=0;C<this._stack.length&&n<p;C++){var e=this._stack[C],i=true;z.forEach(function(r){if(r.test(e))i=false});if(i){l.debug(e);n++}}}});
bespin.tiki.module("bespin:util/util",function(u,j){j.queryToObject=function(d,g){var k={};d=d.split(g||"&");var z=decodeURIComponent;d.forEach(function(p){if(p.length){var n=p.split("=");p=z(n.shift());n=z(n.join("="));if(j.isString(k[p]))k[p]=[k[p]];if(Array.isArray(k[p]))k[p].push(n);else k[p]=n}});return k};j.objectToQuery=function(d){var g=encodeURIComponent,k=[],z={};for(var p in d){var n=d[p];if(n!=z[p]){var C=g(p)+"=";if(n.isArray)for(var e=0;e<n.length;e++)k.push(C+g(n[e]));else k.push(C+
g(n))}}return k.join("&")};var w=0,A={};j.rateLimit=function(d,g,k){if(d){var z=w++;return function(){A[z]&&clearTimeout(A[z]);A[z]=setTimeout(function(){k.apply(g,arguments);delete A[z]},d)}}};j.isString=function(d){return typeof d=="string"||d instanceof String};j.isBoolean=function(d){return typeof d=="boolean"};j.isNumber=function(d){return typeof d=="number"&&isFinite(d)};j.isObject=function(d){return d!==undefined&&(d===null||typeof d=="object"||Array.isArray(d)||j.isFunction(d))};j.isFunction=
function(){var d=function(g){var k=typeof g;return g&&(k=="function"||g instanceof Function)&&!g.nodeType};return j.isSafari?function(g){if(typeof g=="function"&&g=="[object NodeList]")return false;return d(g)}:d}();j.endsWith=function(d,g){if(!d)return false;return d.match(new RegExp(g+"$"))};j.include=function(d,g){return d.indexOf(g)>-1};j.indexOfProperty=function(d,g,k){for(var z=0;z<d.length;z++)if(d[z][g]==k)return z;return null};j.last=function(d){if(Array.isArray(d))return d[d.length-1]};
j.shrinkArray=function(d){var g=[],k=true;d.reverse().forEach(function(z){if(!(k&&z===undefined)){k=false;g.push(z)}});return g.reverse()};j.makeArray=function(d,g){if(d<1)return[];g||(g=" ");for(var k=[],z=0;z<d;z++)k.push(g);return k};j.repeatString=function(d,g){for(var k="",z=0;z<g;z++)k+=d;return k};j.leadingSpaces=function(d){for(var g=0,k=0;k<d.length;k++)if(d[k]==" "||d[k]==""||d[k]===undefined)g++;else return g;return g};j.leadingTabs=function(d){for(var g=0,k=0;k<d.length;k++)if(d[k]=="\t"||
d[k]==""||d[k]===undefined)g++;else return g;return g};j.leadingWhitespace=function(d){for(var g=[],k=0;k<d.length;k++)if(d[k]==" "||d[k]=="\t"||d[k]==""||d[k]===undefined)g.push(d[k]);else return g;return g};j.englishFromCamel=function(d){d.replace(/([A-Z])/g,function(g){return" "+g.toLowerCase()}).trim()};j.OS={LINUX:"LINUX",MAC:"MAC",WINDOWS:"WINDOWS"};u=navigator.userAgent;var s=navigator.appVersion;j.isLinux=s.indexOf("Linux")>=0;j.isWindows=s.indexOf("Win")>=0;j.isWebKit=parseFloat(u.split("WebKit/")[1])||
undefined;j.isChrome=parseFloat(u.split("Chrome/")[1])||undefined;j.isMac=s.indexOf("Macintosh")>=0;j.isMozilla=s.indexOf("Gecko/")>=0;if(u.indexOf("AdobeAIR")>=0)j.isAIR=1;var l=Math.max(s.indexOf("WebKit"),s.indexOf("Safari"),0);if(l&&!j.isChrome){j.isSafari=parseFloat(s.split("Version/")[1]);if(!j.isSafari||parseFloat(s.substr(l+7))<=419.3)j.isSafari=2}if(u.indexOf("Gecko")>=0&&!j.isWebKit)j.isMozilla=parseFloat(s);j.getOS=function(){return j.isMac?j.OS.MAC:j.isLinux?j.OS.LINUX:j.OS.WINDOWS};j.contains=
typeof document!=="undefined"&&document.compareDocumentPosition?function(d,g){return d.compareDocumentPosition(g)&16}:function(d,g){return d!==g&&(d.contains?d.contains(g):true)};j.stopEvent=function(d){d.preventDefault();d.stopPropagation()};j.randomPassword=function(d){d=d||16;for(var g="",k=0;k<d;k++){var z=Math.floor(Math.random()*62);g+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890".charAt(z)}return g};j.isEmpty=function(d){for(var g in d)if(d.hasOwnProperty(g))return false;
return true};j.isMyProject=function(d){return d.indexOf("+")==-1};j.formatDate=function(d){if(!d)return"Unknown";return d.getDate()+" "+j.formatDate.shortMonths[d.getMonth()]+" "+d.getFullYear()};j.formatDate.shortMonths=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];j.addClass=function(d,g){g=g.split(/\s+/);for(var k=" "+d.className+" ",z=0,p=g.length,n;z<p;++z)if((n=g[z])&&k.indexOf(" "+n+" ")<0)k+=n+" ";d.className=k.trim()};j.removeClass=function(d,g){if(g!==undefined){var k=
g.split(/\s+/);g=" "+d.className+" ";for(var z=0,p=k.length;z<p;++z)g=g.replace(" "+k[z]+" "," ");g=g.trim()}else g="";if(d.className!=g)d.className=g};j.setClass=function(d,g,k){k?j.addClass(d,g):j.removeClass(d,g)};j.none=function(d){return d===null||d===undefined};j.clone=function(d,g){if(Array.isArray(d)&&!g)return d.slice();if(typeof d==="object"||Array.isArray(d)){if(d===null)return null;var k=Array.isArray(d)?[]:{};for(var z in d)k[z]=g&&(typeof d[z]==="object"||Array.isArray(d[z]))?j.clone(d[z],
true):d[z];return k}if(d&&typeof d.clone==="function")return d.clone();return d};j.mixin=function(d,g){for(var k in g){var z=g.__lookupGetter__(k),p=g.__lookupSetter__(k);if(z||p){z&&d.__defineGetter__(k,z);p&&d.__defineSetter__(k,p)}else d[k]=g[k]}return d};j.replace=function(d,g,k,z){return d.slice(0,g).concat(z).concat(d.slice(g+k))};j.rectsEqual=function(d,g,k){if(!d||!g)return d==g;if(!k&&k!==0)k=0.1;if(d.y!=g.y&&Math.abs(d.y-g.y)>k)return false;if(d.x!=g.x&&Math.abs(d.x-g.x)>k)return false;
if(d.width!=g.width&&Math.abs(d.width-g.width)>k)return false;if(d.height!=g.height&&Math.abs(d.height-g.height)>k)return false;return true}});bespin.tiki.register("::settings",{name:"settings",dependencies:{types:"0.0.0"}});
bespin.tiki.module("settings:commands",function(u,j){u("bespin:plugins");u("environment");var w=u("settings").settings;j.setCommand=function(A,s){var l;if(A.setting)if(A.value===undefined)l="<strong>"+A.setting+"</strong> = "+w.get(A.setting);else{l="Setting: <strong>"+A.setting+"</strong> = "+A.value;w.set(A.setting,A.value)}else{A=w._list();l="";A.sort(function(d,g){return d.key<g.key?-1:d.key==g.key?0:1});A.forEach(function(d){l+='<a class="setting" href="https://wiki.mozilla.org/Labs/Bespin/Settings#'+
d.key+'" title="View external documentation on setting: '+d.key+'" target="_blank">'+d.key+"</a> = "+d.value+"<br/>"})}s.done(l)};j.unsetCommand=function(A,s){w.resetValue(A.setting);s.done("Reset "+A.setting+" to default: "+w.get(A.setting))}});
bespin.tiki.module("settings:cookie",function(u,j){var w=u("bespin:util/cookie");j.CookiePersister=function(){};j.CookiePersister.prototype={loadInitialValues:function(A){A._loadDefaultValues().then(function(){var s=w.get("settings");A._loadFromObject(JSON.parse(s))}.bind(this))},persistValue:function(A){try{var s={};A._getSettingNames().forEach(function(g){s[g]=A.get(g)});var l=JSON.stringify(s);w.set("settings",l)}catch(d){console.error("Unable to JSONify the settings! "+d)}}}});
bespin.tiki.module("settings:index",function(u,j){var w=u("bespin:plugins").catalog,A=u("bespin:console").console,s=u("bespin:promise").Promise,l=u("bespin:promise").group,d=u("types:types");j.addSetting=function(g){u("settings").settings.addSetting(g)};j.getSettings=function(){return w.getExtensions("setting")};j.getTypeSpecFromAssignment=function(g){var k=g.assignments;g="text";if(k){var z=null;k.forEach(function(p){if(p.param.name==="setting")z=p});if(z)if((k=z.value)&&k!=="")if(k=w.getExtensionByKey("setting",
k))g=k.type}return g};j.MemorySettings=function(){};j.MemorySettings.prototype={_values:{},_deactivated:{},setPersister:function(g){(this._persister=g)&&g.loadInitialValues(this)},get:function(g){return this._values[g]},set:function(g,k){var z=w.getExtensionByKey("setting",g);if(z)if(typeof k=="string"&&z.type=="string")this._values[g]=k;else{var p=false;d.fromString(k,z.type).then(function(n){p=true;this._values[g]=n;w.publish(this,"settingChange",g,n)}.bind(this),function(n){A.error("Error setting",
g,": ",n)});if(!p){A.warn("About to set string version of ",g,"delaying typed set.");this._values[g]=k}}else{A.warn("Setting not defined: ",g,k);this._deactivated[g]=k}this._persistValue(g,k);return this},addSetting:function(g){if(g.name){!g.defaultValue===undefined&&A.error("Setting.defaultValue == undefined",g);d.isValid(g.defaultValue,g.type).then(function(k){k||A.warn("!Setting.isValid(Setting.defaultValue)",g);this.set(g.name,this._deactivated[g.name]||g.defaultValue)}.bind(this),function(k){A.error("Type error ",
k," ignoring setting ",g)})}else A.error("Setting.name == undefined. Ignoring.",g)},resetValue:function(g){var k=w.getExtensionByKey("setting",g);k?this.set(g,k.defaultValue):A.log("ignore resetValue on ",g)},resetAll:function(){this._getSettingNames().forEach(function(g){this.resetValue(g)}.bind(this))},_getSettingNames:function(){var g=[];w.getExtensions("setting").forEach(function(k){g.push(k.name)});return g},_list:function(){var g=[];this._getSettingNames().forEach(function(k){g.push({key:k,
value:this.get(k)})}.bind(this));return g},_persistValue:function(g,k){var z=this._persister;z&&z.persistValue(this,g,k)},_loadInitialValues:function(){var g=this._persister;g?g.loadInitialValues(this):this._loadDefaultValues()},_loadDefaultValues:function(){return this._loadFromObject(this._defaultValues())},_loadFromObject:function(g){var k=[],z=function(i){return function(r){this.set(i,r)}};for(var p in g)if(g.hasOwnProperty(p)){var n=g[p],C=w.getExtensionByKey("setting",p);if(C){n=d.fromString(n,
C.type);C=z(p);n.then(C);k.push(n)}}var e=new s;l(k).then(function(){e.resolve()});return e},_saveToObject:function(){var g=[],k={};this._getSettingNames().forEach(function(p){var n=this.get(p),C=w.getExtensionByKey("setting",p);if(C){n=d.toString(n,C.type);n.then(function(e){k[p]=e});g.push(n)}}.bind(this));var z=new s;l(g).then(function(){z.resolve(k)});return z},_defaultValues:function(){var g={};w.getExtensions("setting").forEach(function(k){g[k.name]=k.defaultValue});return g}};j.settings=new j.MemorySettings});
bespin.tiki.register("::canon",{name:"canon",dependencies:{environment:"0.0.0",events:"0.0.0",settings:"0.0.0"}});
bespin.tiki.module("canon:history",function(u,j){var w=u("bespin:util/stacktrace").Trace,A=u("bespin:plugins").catalog,s=u("bespin:console").console;j.requests=[];j.addRequestOutput=function(l){for(j.requests.push(l);j.requests.length>100;)j.requests.shiftObject();A.publish(this,"addedRequestOutput",null,l)};j.execute=function(l,d){if(d.command)try{d.command(l,d)}catch(g){var k=new w(g,true);s.group("Error executing command '"+d.typed+"'");s.log("command=",d.commandExt);s.log("args=",l);s.error(g);
k.log(3);s.groupEnd();d.doneWithError(g)}else d.doneWithError("Command not found.")}});
bespin.tiki.module("canon:request",function(u,j){var w=u("events").Event,A=u("canon:history");j.Request=function(s){s=s||{};this.command=s.command;this.commandExt=s.commandExt;this.args=s.args;this.typed=s.typed;this._begunOutput=false;this.start=new Date;this.end=null;this.error=this.completed=false;this.changed=new w};j.Request.prototype._beginOutput=function(){this._begunOutput=true;this.outputs=[];A.addRequestOutput(this)};j.Request.prototype.doneWithError=function(s){this.error=true;this.done(s)};
j.Request.prototype.async=function(){this._begunOutput||this._beginOutput()};j.Request.prototype.output=function(s){this._begunOutput||this._beginOutput();if(typeof s!=="string"&&!(s instanceof Node))s=s.toString();this.outputs.push(s);this.changed();return this};j.Request.prototype.done=function(s){this.completed=true;this.end=new Date;this.duration=this.end.getTime()-this.start.getTime();s?this.output(s):this.changed()}});bespin.tiki.module("canon:index",function(){});
bespin.tiki.register("::syntax_directory",{name:"syntax_directory",dependencies:{}});
bespin.tiki.module("syntax_directory:index",function(u,j){function w(l){this.extension=l;this.name=l.name;this.fileExts=l.hasOwnProperty("fileexts")?l.fileexts:[];this.settings=l.settings!=null?l.settings:[]}function A(l){s.register(l)}u("bespin:plugins");var s={_fileExts:{},_syntaxInfo:{},get:function(l){return this._syntaxInfo[l]},hasSyntax:function(l){return this._syntaxInfo.hasOwnProperty(l)},register:function(l){var d=new w(l);this._syntaxInfo[d.name]=d;var g=this._fileExts;d.fileExts.forEach(function(k){g[k]=
d.name})},syntaxForFileExt:function(l){l=l.toLowerCase();var d=this._fileExts;return d.hasOwnProperty(l)?d[l]:"plain"}};j.syntaxDirectory=s;j.discoveredNewSyntax=A});bespin.tiki.register("::environment",{name:"environment",dependencies:{settings:"0.0.0"}});
bespin.tiki.module("environment:index",function(u,j){var w=u("bespin:util/util"),A=u("bespin:console").console,s=u("bespin:plugins").catalog,l=u("settings").settings;j.Environment=function(){this.commandLine=null;window.addEventListener("resize",this.dimensionsChanged.bind(this),false)};Object.defineProperties(j.Environment.prototype,{settings:{value:{set:function(d,g){if(w.none(d))throw new Error("setSetting(): key must be supplied");if(w.none(g))throw new Error("setSetting(): value must be supplied");
l.set(d,g)},get:function(d){if(w.none(d))throw new Error("getSetting(): key must be supplied");return l.get(d)}}},dimensionsChanged:{value:function(){s.publish(this,"dimensionsChanged")}},session:{get:function(){return s.getObject("session")}},view:{get:function(){if(!this.session)return null;return this.session.currentView}},editor:{get:function(){if(!this.session)return null;return this.session.currentView.editor}},contexts:{get:function(){if(!this.view)return[];var d=this.view.editor.layoutManager.syntaxManager,
g=this.view.getSelectedRange().start;return d.contextsAtPosition(g)}},buffer:{get:function(){if(this.session)return this.view.editor.buffer;else A.error("command attempted to get buffer but there's no session")}},model:{get:function(){if(this.buffer)return this.view.editor.layoutManager.textStorage;else A.error("Session has no current buffer")}},file:{get:function(){if(this.buffer)return this.buffer.file;else A.error("Session has no current buffer")}},files:{get:function(){return s.getObject("files")}}});
j.env=new j.Environment});bespin.tiki.register("::traits",{name:"traits",dependencies:{}});
bespin.tiki.module("traits:index",function(u,j){u=function(){function w(){try{if(Object.getOwnPropertyDescriptor)return!!Object.getOwnPropertyDescriptor({x:0},"x")}catch(B){}return false}function A(){try{if(Object.defineProperty){var B={};Object.defineProperty(B,"x",{value:0});return B.x===0}}catch(E){}return false}function s(B){var E=function(){throw new Error("Conflicting property: "+B);};L(E.prototype);return L(E)}function l(){return L({value:undefined,enumerable:false,required:true})}function d(B){B=
s(B);return R?L({get:B,set:B,enumerable:false,conflict:true}):L({value:B,enumerable:false,conflict:true})}function g(B,E){return B===E?B!==0||1/B===1/E:B!==B&&E!==E}function k(B,E){return B.conflict&&E.conflict?true:B.get===E.get&&B.set===E.set&&g(B.value,E.value)&&B.enumerable===E.enumerable&&B.required===E.required&&B.conflict===E.conflict}function z(B,E){return L(N(B,E))}function p(B){var E={};T(B,function(J){E[J]=true});return L(E)}function n(B){var E={};T(f(B),function(J){var a=o(B,J);if(a.value===
O)a=l(J);else if(typeof a.value==="function"){a.method=true;"prototype"in a.value&&L(a.value.prototype)}else{a.get&&a.get.prototype&&L(a.get.prototype);a.set&&a.set.prototype&&L(a.set.prototype)}E[J]=a});return E}function C(){var B=V(arguments,0),E={};T(B,function(J){T(f(J),function(a){var b=J[a];if(U(E,a)&&!E[a].required)b.required||k(E[a],b)||(E[a]=d(a));else E[a]=b})});return L(E)}function e(B,E){var J=p(B),a={};T(f(E),function(b){a[b]=!U(J,b)||E[b].required?E[b]:l(b)});return L(a)}function i(){var B=
V(arguments,0),E={};T(B,function(J){T(f(J),function(a){var b=J[a];if(!U(E,a)||E[a].required)E[a]=b})});return L(E)}function r(B,E){var J={};T(f(E),function(a){if(U(B,a)&&!E[a].required){var b=B[a];J[b]=U(J,b)&&!J[b].required?d(b):E[a];U(J,a)||(J[a]=l(a))}else if(U(J,a))E[a].required||(J[a]=d(a));else J[a]=E[a]});return L(J)}function v(B,E){var J={},a=[];for(var b in B)if(U(B,b))if(B[b])J[b]=B[b];else a.push(b);return r(J,e(a,E))}function D(B,E){var J=I(B),a={};T(f(E),function(b){var c=E[b];if(c.required){if(!(b in
B))throw new Error("Missing required property: "+b);}else if(c.conflict)throw new Error("Remaining conflicting property: "+b);else a[b]="value"in c?c.method?{value:z(c.value,J),enumerable:c.enumerable,configurable:c.configurable,writable:c.writable}:c:{get:c.get?z(c.get,J):undefined,set:c.set?z(c.set,J):undefined,enumerable:c.enumerable,configurable:c.configurable,writable:c.writable}});x(J,a);return L(J)}function G(B,E){return D(Object.prototype,n(B),E)}function P(B,E){var J=f(B),a=f(E);if(J.length!==
a.length)return false;for(var b=0;b<J.length;b++){a=J[b];if(!E[a]||!k(B[a],E[a]))return false}return true}function K(B){return n(B)}var R=function(){try{var B={};Object.defineProperty(B,"x",{get:function(){return 0}});return B.x===0}catch(E){return false}}(),m=Function.prototype.call,N=Function.prototype.bind?function(B,E){return Function.prototype.bind.call(B,E)}:function(B,E){function J(){return B.apply(E,arguments)}return J},U=N(m,Object.prototype.hasOwnProperty),V=N(m,Array.prototype.slice),T=
Array.prototype.forEach?N(m,Array.prototype.forEach):function(B,E){for(var J=0,a=B.length;J<a;J++)E(B[J])},L=Object.freeze?function(B){Object.freeze(B);return B}:function(B){return B},f=Object.getOwnPropertyNames||function(B){var E=[];for(var J in B)U(B,J)&&E.push(J);return E},o=w()?Object.getOwnPropertyDescriptor:function(B,E){return{value:B[E],enumerable:true,writable:true,configurable:true}},y=A()?Object.defineProperty:function(B,E,J){B[E]=J.value},x=Object.defineProperties||function(B,E){for(var J in E)U(E,
J)&&y(B,J,E[J])},I=Object.create||function(B,E){function J(){}J.prototype=B||Object.prototype;B=new J;E&&x(B,E);return B};m=Object.getOwnProperties||function(B){var E={};T(f(B),function(J){E[J]=o(B,J)});return E};var O=L({toString:function(){return"<Trait.required>"}});if(!Object.create)Object.create=I;if(!Object.getOwnProperties)Object.getOwnProperties=m;K.required=L(O);K.compose=L(C);K.resolve=L(v);K.override=L(i);K.create=L(D);K.eqv=L(P);K.object=L(G);return L(K)}();if(typeof j!=="undefined")j.Trait=
u});bespin.tiki.register("::underscore",{name:"underscore",dependencies:{}});
bespin.tiki.module("underscore:index",function(u,j){(function(){var w=this,A=w._,s=typeof StopIteration!=="undefined"?StopIteration:"__break__",l=function(f){return f.replace(/([.*+?^${}()|[\]\/\\])/g,"\\$1")},d=Array.prototype,g=Object.prototype,k=d.slice,z=d.unshift,p=g.toString,n=g.hasOwnProperty,C=d.forEach,e=d.map,i=d.reduce,r=d.reduceRight,v=d.filter,D=d.every,G=d.some,P=d.indexOf,K=d.lastIndexOf;g=Array.isArray;var R=Object.keys,m=function(f){return new V(f)};if(typeof j!=="undefined")j._=
m;w._=m;m.VERSION="1.0.2";var N=m.forEach=function(f,o,y){try{if(C&&f.forEach===C)f.forEach(o,y);else if(m.isNumber(f.length))for(var x=0,I=f.length;x<I;x++)o.call(y,f[x],x,f);else for(x in f)n.call(f,x)&&o.call(y,f[x],x,f)}catch(O){if(O!=s)throw O;}return f};m.map=function(f,o,y){if(e&&f.map===e)return f.map(o,y);var x=[];N(f,function(I,O,B){x.push(o.call(y,I,O,B))});return x};m.reduce=function(f,o,y,x){if(i&&f.reduce===i)return f.reduce(m.bind(y,x),o);N(f,function(I,O,B){o=y.call(x,o,I,O,B)});return o};
m.reduceRight=function(f,o,y,x){if(r&&f.reduceRight===r)return f.reduceRight(m.bind(y,x),o);f=m.clone(m.toArray(f)).reverse();return m.reduce(f,o,y,x)};m.detect=function(f,o,y){var x;N(f,function(I,O,B){if(o.call(y,I,O,B)){x=I;m.breakLoop()}});return x};m.filter=function(f,o,y){if(v&&f.filter===v)return f.filter(o,y);var x=[];N(f,function(I,O,B){o.call(y,I,O,B)&&x.push(I)});return x};m.reject=function(f,o,y){var x=[];N(f,function(I,O,B){!o.call(y,I,O,B)&&x.push(I)});return x};m.every=function(f,o,
y){o=o||m.identity;if(D&&f.every===D)return f.every(o,y);var x=true;N(f,function(I,O,B){(x=x&&o.call(y,I,O,B))||m.breakLoop()});return x};m.some=function(f,o,y){o=o||m.identity;if(G&&f.some===G)return f.some(o,y);var x=false;N(f,function(I,O,B){if(x=o.call(y,I,O,B))m.breakLoop()});return x};m.include=function(f,o){if(P&&f.indexOf===P)return f.indexOf(o)!=-1;var y=false;N(f,function(x){if(y=x===o)m.breakLoop()});return y};m.invoke=function(f,o){var y=m.rest(arguments,2);return m.map(f,function(x){return(o?
x[o]:x).apply(x,y)})};m.pluck=function(f,o){return m.map(f,function(y){return y[o]})};m.max=function(f,o,y){if(!o&&m.isArray(f))return Math.max.apply(Math,f);var x={computed:-Infinity};N(f,function(I,O,B){O=o?o.call(y,I,O,B):I;O>=x.computed&&(x={value:I,computed:O})});return x.value};m.min=function(f,o,y){if(!o&&m.isArray(f))return Math.min.apply(Math,f);var x={computed:Infinity};N(f,function(I,O,B){O=o?o.call(y,I,O,B):I;O<x.computed&&(x={value:I,computed:O})});return x.value};m.sortBy=function(f,
o,y){return m.pluck(m.map(f,function(x,I,O){return{value:x,criteria:o.call(y,x,I,O)}}).sort(function(x,I){x=x.criteria;I=I.criteria;return x<I?-1:x>I?1:0}),"value")};m.sortedIndex=function(f,o,y){y=y||m.identity;for(var x=0,I=f.length;x<I;){var O=x+I>>1;y(f[O])<y(o)?(x=O+1):(I=O)}return x};m.toArray=function(f){if(!f)return[];if(f.toArray)return f.toArray();if(m.isArray(f))return f;if(m.isArguments(f))return k.call(f);return m.values(f)};m.size=function(f){return m.toArray(f).length};m.first=function(f,
o,y){return o&&!y?k.call(f,0,o):f[0]};m.rest=function(f,o,y){return k.call(f,m.isUndefined(o)||y?1:o)};m.last=function(f){return f[f.length-1]};m.compact=function(f){return m.filter(f,function(o){return!!o})};m.flatten=function(f){return m.reduce(f,[],function(o,y){if(m.isArray(y))return o.concat(m.flatten(y));o.push(y);return o})};m.without=function(f){var o=m.rest(arguments);return m.filter(f,function(y){return!m.include(o,y)})};m.uniq=function(f,o){return m.reduce(f,[],function(y,x,I){if(0==I||
(o===true?m.last(y)!=x:!m.include(y,x)))y.push(x);return y})};m.intersect=function(f){var o=m.rest(arguments);return m.filter(m.uniq(f),function(y){return m.every(o,function(x){return m.indexOf(x,y)>=0})})};m.zip=function(){for(var f=m.toArray(arguments),o=m.max(m.pluck(f,"length")),y=new Array(o),x=0;x<o;x++)y[x]=m.pluck(f,String(x));return y};m.indexOf=function(f,o){if(P&&f.indexOf===P)return f.indexOf(o);for(var y=0,x=f.length;y<x;y++)if(f[y]===o)return y;return-1};m.lastIndexOf=function(f,o){if(K&&
f.lastIndexOf===K)return f.lastIndexOf(o);for(var y=f.length;y--;)if(f[y]===o)return y;return-1};m.range=function(f,o,y){var x=m.toArray(arguments),I=x.length<=1;f=I?0:x[0];o=I?x[0]:x[1];y=x[2]||1;x=Math.ceil((o-f)/y);if(x<=0)return[];x=new Array(x);I=f;for(var O=0;;I+=y){if((y>0?I-o:o-I)>=0)return x;x[O++]=I}};m.bind=function(f,o){var y=m.rest(arguments,2);return function(){return f.apply(o||{},y.concat(m.toArray(arguments)))}};m.bindAll=function(f){var o=m.rest(arguments);if(o.length==0)o=m.functions(f);
N(o,function(y){f[y]=m.bind(f[y],f)});return f};m.delay=function(f,o){var y=m.rest(arguments,2);return setTimeout(function(){return f.apply(f,y)},o)};m.defer=function(f){return m.delay.apply(m,[f,1].concat(m.rest(arguments)))};m.wrap=function(f,o){return function(){var y=[f].concat(m.toArray(arguments));return o.apply(o,y)}};m.compose=function(){var f=m.toArray(arguments);return function(){for(var o=m.toArray(arguments),y=f.length-1;y>=0;y--)o=[f[y].apply(this,o)];return o[0]}};m.keys=R||function(f){if(m.isArray(f))return m.range(0,
f.length);var o=[];for(var y in f)n.call(f,y)&&o.push(y);return o};m.values=function(f){return m.map(f,m.identity)};m.functions=function(f){return m.filter(m.keys(f),function(o){return m.isFunction(f[o])}).sort()};m.extend=function(f){N(m.rest(arguments),function(o){for(var y in o)f[y]=o[y]});return f};m.clone=function(f){if(m.isArray(f))return f.slice(0);return m.extend({},f)};m.tap=function(f,o){o(f);return f};m.isEqual=function(f,o){if(f===o)return true;var y=typeof f;if(y!=typeof o)return false;
if(f==o)return true;if(!f&&o||f&&!o)return false;if(f.isEqual)return f.isEqual(o);if(m.isDate(f)&&m.isDate(o))return f.getTime()===o.getTime();if(m.isNaN(f)&&m.isNaN(o))return true;if(m.isRegExp(f)&&m.isRegExp(o))return f.source===o.source&&f.global===o.global&&f.ignoreCase===o.ignoreCase&&f.multiline===o.multiline;if(y!=="object")return false;if(f.length&&f.length!==o.length)return false;y=m.keys(f);var x=m.keys(o);if(y.length!=x.length)return false;for(var I in f)if(!(I in o)||!m.isEqual(f[I],o[I]))return false;
return true};m.isEmpty=function(f){if(m.isArray(f)||m.isString(f))return f.length===0;for(var o in f)if(n.call(f,o))return false;return true};m.isElement=function(f){return!!(f&&f.nodeType==1)};m.isArray=g||function(f){return!!(f&&f.concat&&f.unshift&&!f.callee)};m.isArguments=function(f){return f&&f.callee};m.isFunction=function(f){return!!(f&&f.constructor&&f.call&&f.apply)};m.isString=function(f){return!!(f===""||f&&f.charCodeAt&&f.substr)};m.isNumber=function(f){return f===+f||p.call(f)==="[object Number]"};
m.isBoolean=function(f){return f===true||f===false};m.isDate=function(f){return!!(f&&f.getTimezoneOffset&&f.setUTCFullYear)};m.isRegExp=function(f){return!!(f&&f.test&&f.exec&&(f.ignoreCase||f.ignoreCase===false))};m.isNaN=function(f){return m.isNumber(f)&&isNaN(f)};m.isNull=function(f){return f===null};m.isUndefined=function(f){return typeof f=="undefined"};m.noConflict=function(){w._=A;return this};m.identity=function(f){return f};m.times=function(f,o,y){for(var x=0;x<f;x++)o.call(y,x)};m.breakLoop=
function(){throw s;};m.mixin=function(f){N(m.functions(f),function(o){L(o,m[o]=f[o])})};var U=0;m.uniqueId=function(f){var o=U++;return f?f+o:o};m.templateSettings={start:"<%",end:"%>",interpolate:/<%=(.+?)%>/g};m.template=function(f,o){var y=m.templateSettings,x=new RegExp("'(?=[^"+y.end.substr(0,1)+"]*"+l(y.end)+")","g");f=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+f.replace(/[\r\t\n]/g," ").replace(x,"\t").split("'").join("\\'").split("\t").join("'").replace(y.interpolate,
"',$1,'").split(y.start).join("');").split(y.end).join("p.push('")+"');}return p.join('');");return o?f(o):f};m.each=m.forEach;m.foldl=m.inject=m.reduce;m.foldr=m.reduceRight;m.select=m.filter;m.all=m.every;m.any=m.some;m.head=m.first;m.tail=m.rest;m.methods=m.functions;var V=function(f){this._wrapped=f},T=function(f,o){return o?m(f).chain():f},L=function(f,o){V.prototype[f]=function(){var y=m.toArray(arguments);z.call(y,this._wrapped);return T(o.apply(m,y),this._chain)}};m.mixin(m);N(["pop","push",
"reverse","shift","sort","splice","unshift"],function(f){var o=d[f];V.prototype[f]=function(){o.apply(this._wrapped,arguments);return T(this._wrapped,this._chain)}});N(["concat","join","slice"],function(f){var o=d[f];V.prototype[f]=function(){return T(o.apply(this._wrapped,arguments),this._chain)}});V.prototype.chain=function(){this._chain=true;return this};V.prototype.value=function(){return this._wrapped}})();j._.noConflict()});
bespin.tiki.register("::worker_manager",{name:"worker_manager",dependencies:{canon:"0.0.0",events:"0.0.0",underscore:"0.0.0"}});
bespin.tiki.module("worker_manager:index",function(u,j){function w(p){var n=/^([^#:]+)(?::([^#:]+))?#([^#:]+)$/.exec(p);if(n==null)throw new Error('WorkerSupervisor: invalid pointer specification: "'+p+'"');p=n[1];var C=n[3];n=p+":"+(n[2]!=null?n[2]:"index");var e=bespin!=null&&bespin.base!=null?bespin.base:"";this._packageId=p;this._moduleId=n;this._base=e;this._target=C;this._worker=null;this._currentId=0;this.started=new g}function A(){z.restartAll()}if(window==null)throw new Error('The "worker_manager" plugin can only be loaded in the browser, not a web worker. Use "worker" instead.');
var s=u("bespin:proxy");u("bespin:plugins");var l=u("bespin:console").console,d=u("underscore")._,g=u("events").Event,k=u("bespin:promise").Promise;u("environment");var z={_workers:[],add:function(p){this._workers.push(p)},remove:function(p){this._workers=d(this._workers).without(p)},restartAll:function(){var p=this._workers;d(p).invoke("kill");d(p).invoke("start")}};w.prototype={_onError:function(p){this._worker=null;z.remove(this);l.error("WorkerSupervisor: worker failed at file "+p.filename+":"+
p.lineno+"; fix the worker and use 'worker restart' to restart it")},_onMessage:function(p){p=JSON.parse(p.data);switch(p.op){case "finish":if(p.id===this._currentId){var n=this._promise;this._promise=null;n.resolve(p.result)}break;case "log":l[p.method].apply(l,p.args);break}},_promise:null,started:null,kill:function(){var p=this._promise;if(p!=null){p.reject("killed");this._promise=null}this._worker.terminate();this._worker=null;z.remove(this)},send:function(p,n){var C=this._promise;if(C!=null){C.reject("interrupted");
this._currentId++}C=this._currentId;var e=new k;this._promise=e;this._worker.postMessage(JSON.stringify({op:"invoke",id:C,method:p,args:n}));return e},start:function(){if(this._worker!=null)throw new Error("WorkerSupervisor: worker already started");var p=this._base,n=this._target,C=this._packageId,e=this._moduleId,i=new s.Worker(p+"BespinEmbedded.js");i.onmessage=this._onMessage.bind(this);i.onerror=this._onError.bind(this);i.postMessage(JSON.stringify({op:"load",base:p,pkg:C,module:e,target:n}));
this._worker=i;this._currentId=0;z.add(this);this.started()}};j.WorkerSupervisor=w;j.workerManager=z;j.workerRestartCommand=A});bespin.tiki.register("::events",{name:"events",dependencies:{traits:"0.0.0"}});
bespin.tiki.module("events:index",function(u,j){j.Event=function(){var w=[],A=function(){var s=arguments;w.forEach(function(l){l.func.apply(null,s)})};A.add=function(){arguments.length==1?w.push({ref:arguments[0],func:arguments[0]}):w.push({ref:arguments[0],func:arguments[1]})};A.remove=function(s){w=w.filter(function(l){return s!==l.ref})};A.removeAll=function(){w=[]};return A}});bespin.tiki.register("::types",{name:"types",dependencies:{}});
bespin.tiki.module("types:basic",function(u,j){var w=u("bespin:plugins").catalog,A=u("bespin:console").console,s=u("bespin:promise").Promise;j.text={isValid:function(l){return typeof l=="string"},toString:function(l){return l},fromString:function(l){return l}};j.number={isValid:function(l){if(isNaN(l))return false;if(l===null)return false;if(l===undefined)return false;if(l===Infinity)return false;return typeof l=="number"},toString:function(l){if(!l)return null;return""+l},fromString:function(l){if(!l)return null;
var d=parseInt(l,10);if(isNaN(d))throw new Error("Can't convert \""+l+'" to a number.');return d}};j.bool={isValid:function(l){return typeof l=="boolean"},toString:function(l){return""+l},fromString:function(l){if(l===null)return null;if(!l.toLowerCase)return!!l;var d=l.toLowerCase();if(d=="true")return true;else if(d=="false")return false;return!!l}};j.object={isValid:function(l){return typeof l=="object"},toString:function(l){return JSON.stringify(l)},fromString:function(l){return JSON.parse(l)}};
j.selection={isValid:function(l,d){if(typeof l!="string")return false;if(!d.data){A.error("Missing data on selection type extension. Skipping");return true}var g=false;d.data.forEach(function(k){if(l==k)g=true});return g},toString:function(l){return l},fromString:function(l){return l},resolveTypeSpec:function(l,d){var g=new s;if(d.data){l.data=d.data;g.resolve()}else if(d.pointer)w.loadObjectForPropertyPath(d.pointer).then(function(k){k=k(d);if(typeof k.then==="function")k.then(function(z){l.data=
z;g.resolve()});else{l.data=k;g.resolve()}},function(k){g.reject(k)});else{A.warn("Missing data/pointer for selection",d);g.resolve()}return g}}});
bespin.tiki.module("types:types",function(u,j){function w(d){var g=new l,k=s.getExtensionByKey("type",d.name);k?g.resolve({ext:k,typeSpec:d}):g.reject(new Error("Unknown type: "+d.name));return g}function A(d){if(typeof d==="string")return w({name:d});if(typeof d==="object")if(d.name==="deferred"){var g=new l;j.undeferTypeSpec(d).then(function(k){A(k).then(function(z){g.resolve(z)},function(z){g.reject(z)})});return g}else return w(d);throw new Error("Unknown typeSpec type: "+typeof d);}var s=u("bespin:plugins").catalog;
u("bespin:console");var l=u("bespin:promise").Promise;j.getSimpleName=function(d){if(!d)throw new Error("null|undefined is not a valid typeSpec");if(typeof d=="string")return d;if(typeof d=="object"){if(!d.name)throw new Error("Missing name member to typeSpec");return d.name}throw new Error("Not a typeSpec: "+d);};j.equals=function(d,g){return j.getSimpleName(d)==j.getSimpleName(g)};j.undeferTypeSpec=function(d){var g=new l;if(!d.pointer){g.reject(new Error("Missing deferred pointer"));return g}s.loadObjectForPropertyPath(d.pointer).then(function(k){k=
k(d);typeof k.then==="function"?k.then(function(z){g.resolve(z)},function(z){g.reject(z)}):g.resolve(k)},function(k){g.reject(k)});return g};j.resolveType=function(d){var g=new l;A(d).then(function(k){k.ext.load(function(z){typeof z.resolveTypeSpec==="function"?z.resolveTypeSpec(k.ext,k.typeSpec).then(function(){g.resolve({type:z,ext:k.ext})},function(p){g.reject(p)}):g.resolve({type:z,ext:k.ext})})},function(k){g.reject(k)});return g};j.fromString=function(d,g){var k=new l;j.resolveType(g).then(function(z){k.resolve(z.type.fromString(d,
z.ext))});return k};j.toString=function(d,g){var k=new l;j.resolveType(g).then(function(z){k.resolve(z.type.toString(d,z.ext))});return k};j.isValid=function(d,g){var k=new l;j.resolveType(g).then(function(z){k.resolve(z.type.isValid(d,z.ext))});return k}});bespin.tiki.module("types:index",function(){});bespin.tiki.register("::syntax_manager",{name:"syntax_manager",dependencies:{worker_manager:"0.0.0",syntax_directory:"0.0.0",events:"0.0.0",underscore:"0.0.0",settings:"0.0.0"}});
bespin.tiki.module("syntax_manager:index",function(u,j){function w(n,C,e,i){for(;n.length<C;)n.push(d(i).clone());C=[C,e.length].concat(e);Array.prototype.splice.apply(n,C);return n}function A(){this._lines=[];this._syms={}}function s(n,C){this._syntaxInfo=n;this._syntaxManager=C;this._invalidRow=0;this._states=[];this._active=false;this.symbols=new A}function l(n){this.layoutManager=n;this.attrsChanged=new g;this.syntaxChanged=new g;this._contextRanges=this._invalidRows=this._context=null;this._attrs=
[];this._symbols=new A;this._syntax="plain";this._reset()}var d=u("underscore")._,g=u("events").Event,k=u("worker_manager").WorkerSupervisor;u("bespin:console");u("rangeutils:utils/range");var z=u("settings").settings,p=u("syntax_directory").syntaxDirectory;A.prototype={get:function(n){return this._syms["-"+n]},replaceLine:function(n,C){function e(v){return v.substring(1)}var i=this._lines,r=this._syms;n<i.length&&d(i[n]).isArray()&&d(i[n]).each(function(v){delete r["-"+v]});i[n]=d(C).keys().map(e);
d(r).extend(C)}};s.prototype={_annotate:function(){if(this._invalidRow==null)throw new Error("syntax_manager.Context: attempt to annotate without any invalid row");if(!this._active)throw new Error("syntax_manager.Context: attempt to annotate while inactive");if(this._worker==null)this._createWorker();else{var n=this._syntaxManager.getTextLines(),C=this._invalidRow,e=C===0?this.getName()+":start":this._states[C],i=Math.min(n.length,C+100);n=n.slice(C,i);var r={start:{row:C,col:0},end:{row:i-1,col:d(n).last().length}};
this._worker.send("annotate",[e,n,r]).then(d(this._annotationFinished).bind(this,C,i))}},_annotationFinished:function(n,C,e){if(this._active){var i=this._syntaxManager;i.mergeAttrs(n,e.attrs);i.mergeSymbols(n,e.symbols);w(this._states,n,e.states);if(C>=this._getRowCount()){this._invalidRow=null;this._active=false}else{this._invalidRow=C;this._annotate()}}},_createWorker:function(){if(this._syntaxInfo==null)return false;var n=new k("syntax_worker#syntaxWorker");this._worker=n;n.started.add(this._workerStarted.bind(this));
n.start();return true},_getRowCount:function(){return this._syntaxManager.getTextLines().length},_workerStarted:function(){this._syntaxInfo.settings.forEach(function(n){var C=z.get(n);this._worker.send("setSyntaxSetting",[n,C])},this);this._worker.send("loadSyntax",[this._syntaxInfo.name]);this._active&&this._annotate()},activateAndAnnotate:function(){this._active=true;this._annotate()},contextsAtPosition:function(){var n=this._syntaxInfo;if(n==null)return["plain"];return[n.name]},cut:function(n){var C=
this._getRowCount();if(n<0||n>=C)throw new Error("Attempt to cut the context at an invalid row");if(!(this._invalidRow!=null&&this._invalidRow<n)){this._invalidRow=n;this._active=false}},getName:function(){return this._syntaxInfo.name},kill:function(){var n=this._worker;if(n!=null){n.kill();this._worker=null}}};l.prototype={_getTextStorage:function(){return this.layoutManager.textStorage},_reset:function(){var n=this._context;if(n!=null){n.kill();this._context=null}n=this._syntax;n=n==="plain"?null:
p.get(n);this._context=n=new s(n,this);n.activateAndAnnotate()},attrsChanged:null,syntaxChanged:null,contextsAtPosition:function(n){return this._context.contextsAtPosition(n)},getAttrsForRows:function(n,C){return this._attrs.slice(n,C)},getSymbol:function(n){return this._symbols.get(n)},getSyntax:function(){return this._syntax},getTextLines:function(){return this._getTextStorage().lines},invalidateRow:function(n){var C=this._context;C.cut(n);C.activateAndAnnotate()},mergeAttrs:function(n,C){w(this._attrs,
n,C,[]);this.attrsChanged(n,n+C.length)},mergeSymbols:function(n,C){var e=this._symbols;d(C).each(function(i,r){e.replaceLine(n+r,i)})},setSyntax:function(n){this._syntax=p.hasSyntax(n)?n:"plain";this.syntaxChanged(n);this._reset()},setSyntaxFromFileExt:function(n){return this.setSyntax(p.syntaxForFileExt(n))}};j.SyntaxManager=l});
bespin.tiki.require("bespin:plugins").catalog.registerMetadata({traits:{resourceURL:"resources/traits/",description:"Traits library, traitsjs.org",dependencies:{},testmodules:[],provides:[],type:"plugins\\thirdparty",name:"traits"},settings:{resourceURL:"resources/settings/",description:"Infrastructure and commands for managing user preferences",share:true,dependencies:{types:"0.0"},testmodules:[],provides:[{indexOn:"name",description:"A setting is something that the application offers as a way to customize how it works",
register:"index#addSetting",ep:"extensionpoint",name:"setting"},{description:"A settingChange is a way to be notified of changes to a setting",ep:"extensionpoint",name:"settingChange"},{pointer:"commands#setCommand",description:"define and show settings",params:[{defaultValue:null,type:{pointer:"settings:index#getSettings",name:"selection"},name:"setting",description:"The name of the setting to display or alter"},{defaultValue:null,type:{pointer:"settings:index#getTypeSpecFromAssignment",name:"deferred"},
name:"value",description:"The new value for the chosen setting"}],ep:"command",name:"set"},{pointer:"commands#unsetCommand",description:"unset a setting entirely",params:[{type:{pointer:"settings:index#getSettings",name:"selection"},name:"setting",description:"The name of the setting to return to defaults"}],ep:"command",name:"unset"}],type:"plugins\\supported",name:"settings"},canon:{resourceURL:"resources/canon/",name:"canon",environments:{main:true,worker:false},dependencies:{environment:"0.0.0",
events:"0.0.0",settings:"0.0.0"},testmodules:[],provides:[{indexOn:"name",description:"A command is a bit of functionality with optional typed arguments which can do something small like moving the cursor around the screen, or large like cloning a project from VCS.",ep:"extensionpoint",name:"command"},{description:"An extension point to be called whenever a new command begins output.",ep:"extensionpoint",name:"addedRequestOutput"},{description:"A dimensionsChanged is a way to be notified of changes to the dimension of Bespin",
ep:"extensionpoint",name:"dimensionsChanged"},{description:"How many typed commands do we recall for reference?",defaultValue:50,type:"number",ep:"setting",name:"historyLength"},{action:"create",pointer:"history#InMemoryHistory",ep:"factory",name:"history"}],type:"plugins\\supported",description:"Manages commands"},events:{resourceURL:"resources/events/",description:"Dead simple event implementation",dependencies:{traits:"0.0"},testmodules:["tests\\test"],provides:[],type:"plugins\\supported",name:"events"},
environment:{testmodules:[],dependencies:{settings:"0.0.0"},resourceURL:"resources/environment/",name:"environment",type:"plugins\\supported"},bespin:{testmodules:[],resourceURL:"resources/bespin/",name:"bespin",environments:{main:true,worker:true},type:"plugins\\boot"},underscore:{testmodules:[],type:"plugins\\thirdparty",resourceURL:"resources/underscore/",description:"Functional Programming Aid for Javascript. Works well with jQuery.",name:"underscore"},worker_manager:{resourceURL:"resources/worker_manager/",
description:"Manages a web worker on the browser side",dependencies:{canon:"0.0.0",events:"0.0.0",underscore:"0.0.0"},testmodules:[],provides:[{description:"Low-level web worker control (for plugin development)",ep:"command",name:"worker"},{description:"Restarts all web workers (for plugin development)",pointer:"#workerRestartCommand",ep:"command",name:"worker restart"}],type:"plugins\\supported",name:"worker_manager"},syntax_directory:{resourceURL:"resources/syntax_directory/",name:"syntax_directory",
environments:{main:true,worker:true},dependencies:{},testmodules:[],provides:[{register:"#discoveredNewSyntax",ep:"extensionhandler",name:"syntax"}],type:"plugins\\supported",description:"Catalogs the available syntax engines"},types:{resourceURL:"resources/types/",description:"Defines parameter types for commands",testmodules:["tests\\testBasic","tests\\testTypes"],provides:[{indexOn:"name",description:"Commands can accept various arguments that the user enters or that are automatically supplied by the environment. Those arguments have types that define how they are supplied or completed. The pointer points to an object with methods convert(str value) and getDefault(). Both functions have `this` set to the command's `takes` parameter. If getDefault is not defined, the default on the command's `takes` is used, if there is one. The object can have a noInput property that is set to true to reflect that this type is provided directly by the system. getDefault must be defined in that case.",
ep:"extensionpoint",name:"type"},{description:"Text that the user needs to enter.",pointer:"basic#text",ep:"type",name:"text"},{description:"A JavaScript number",pointer:"basic#number",ep:"type",name:"number"},{description:"A true/false value",pointer:"basic#bool",ep:"type",name:"boolean"},{description:"An object that converts via JavaScript",pointer:"basic#object",ep:"type",name:"object"},{description:"A string that is constrained to be one of a number of pre-defined values",pointer:"basic#selection",
ep:"type",name:"selection"},{description:"A type which we don't understand from the outset, but which we hope context can help us with",ep:"type",name:"deferred"}],type:"plugins\\supported",name:"types"},syntax_manager:{resourceURL:"resources/syntax_manager/",name:"syntax_manager",environments:{main:true,worker:false},dependencies:{worker_manager:"0.0.0",syntax_directory:"0.0.0",events:"0.0.0",underscore:"0.0.0",settings:"0.0.0"},testmodules:[],provides:[],type:"plugins\\supported",description:"Provides syntax highlighting services for the editor"}});
typeof window==="undefined"?importScripts("BespinWorker.js"):function(){var u=document.createElement("script");u.setAttribute("src",bespin.base+"BespinMain.js");document.getElementsByTagName("head")[0].appendChild(u)}();
